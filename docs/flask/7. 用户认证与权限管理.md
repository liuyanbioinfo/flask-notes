# ğŸ” 7. ç”¨æˆ·è®¤è¯ä¸æˆæƒç³»ç»Ÿ

ç”¨æˆ·è®¤è¯ä¸æˆæƒæ˜¯Webåº”ç”¨å®‰å…¨çš„æ ¸å¿ƒç»„æˆéƒ¨åˆ†ã€‚è®¤è¯ï¼ˆAuthenticationï¼‰è§£å†³"ä½ æ˜¯è°"çš„é—®é¢˜ï¼Œè€Œæˆæƒï¼ˆAuthorizationï¼‰è§£å†³"ä½ èƒ½åšä»€ä¹ˆ"çš„é—®é¢˜ã€‚æœ¬ç« å°†æ·±å…¥æ¢è®¨Flaskä¸­æ„å»ºå®‰å…¨ã€å¯æ‰©å±•çš„ç”¨æˆ·è®¤è¯ä¸æˆæƒç³»ç»Ÿçš„å„ç§æ–¹æ³•å’Œæœ€ä½³å®è·µã€‚

## ğŸ›¡ï¸ 7.1 ä¼šè¯ç®¡ç†ä¸å®‰å…¨æ€§

### ä¼šè¯ç®¡ç†åŸºç¡€

ä¼šè¯ç®¡ç†æ˜¯Webåº”ç”¨ä¸­ç»´æŠ¤ç”¨æˆ·çŠ¶æ€çš„æ ¸å¿ƒæœºåˆ¶ã€‚Flaské€šè¿‡Sessionå¯¹è±¡æä¾›äº†å®‰å…¨çš„ä¼šè¯ç®¡ç†åŠŸèƒ½ã€‚

```mermaid
sequenceDiagram
    participant C as å®¢æˆ·ç«¯
    participant S as FlaskæœåŠ¡å™¨
    participant D as æ•°æ®å­˜å‚¨
    
    C->>S: ç™»å½•è¯·æ±‚
    S->>D: éªŒè¯ç”¨æˆ·å‡­æ®
    D-->>S: éªŒè¯ç»“æœ
    S->>S: ç”Ÿæˆä¼šè¯ID
    S-->>C: è¿”å›ä¼šè¯Cookie
    C->>S: åç»­è¯·æ±‚(æºå¸¦Cookie)
    S->>S: éªŒè¯ä¼šè¯
    S-->>C: å“åº”æ•°æ®
```

### Flaskä¼šè¯é…ç½®
app/config.py
```python
import os
from datetime import timedelta

class Config:
    # ä¼šè¯å®‰å…¨é…ç½®
    SECRET_KEY = os.environ.get('SECRET_KEY') or 'dev-secret-key-change-in-production'
    
    # ä¼šè¯Cookieé…ç½®
    SESSION_COOKIE_SECURE = True  # ä»…HTTPSä¼ è¾“
    SESSION_COOKIE_HTTPONLY = True  # é˜²æ­¢XSSæ”»å‡»
    SESSION_COOKIE_SAMESITE = 'Lax'  # CSRFé˜²æŠ¤
    PERMANENT_SESSION_LIFETIME = timedelta(hours=24)  # ä¼šè¯è¿‡æœŸæ—¶é—´
    
    # ä¼šè¯å­˜å‚¨é…ç½®
    SESSION_TYPE = 'filesystem'  # æˆ– 'redis', 'memcached'
    SESSION_FILE_DIR = '/tmp/flask_session'
```

### å®‰å…¨ä¼šè¯å®ç°
app/auth/session.py
```python
from flask import session, request, current_app
from functools import wraps
import hashlib
import time

class SecureSession:
    @staticmethod
    def create_session(user_id, remember_me=False):
        """åˆ›å»ºå®‰å…¨ä¼šè¯"""
        session.permanent = remember_me
        session['user_id'] = user_id
        session['csrf_token'] = SecureSession._generate_csrf_token()
        session['login_time'] = time.time()
        session['ip_address'] = request.remote_addr
    
    @staticmethod
    def _generate_csrf_token():
        """ç”ŸæˆCSRFä»¤ç‰Œ"""
        return hashlib.sha256(
            f"{current_app.secret_key}{time.time()}".encode()
        ).hexdigest()[:32]
    
    @staticmethod
    def validate_session():
        """éªŒè¯ä¼šè¯å®‰å…¨æ€§"""
        if 'user_id' not in session:
            return False
            
        # IPåœ°å€éªŒè¯ï¼ˆå¯é€‰ï¼‰
        if session.get('ip_address') != request.remote_addr:
            current_app.logger.warning(f"IPåœ°å€å˜æ›´: {session.get('ip_address')} -> {request.remote_addr}")
            
        return True
    
    @staticmethod
    def destroy_session():
        """é”€æ¯ä¼šè¯"""
        session.clear()

def require_csrf_token(f):
    """CSRFä¿æŠ¤è£…é¥°å™¨"""
    @wraps(f)
    def decorated_function(*args, **kwargs):
        if request.method == 'POST':
            token = request.form.get('csrf_token') or request.headers.get('X-CSRF-Token')
            if not token or token != session.get('csrf_token'):
                return {'error': 'CSRF token validation failed'}, 403
        return f(*args, **kwargs)
    return decorated_function
```

## ğŸ‘¤ 7.2 ç”¨æˆ·è®¤è¯ç³»ç»Ÿè®¾è®¡

### è®¤è¯ç³»ç»Ÿæ¶æ„

```mermaid
graph TD
    A[ç”¨æˆ·è¯·æ±‚] --> B{å·²è®¤è¯?}
    B -->|æ˜¯| C[è®¿é—®èµ„æº]
    B -->|å¦| D[é‡å®šå‘åˆ°ç™»å½•]
    D --> E[ç”¨æˆ·è¾“å…¥å‡­æ®]
    E --> F[éªŒè¯å‡­æ®]
    F -->|æˆåŠŸ| G[åˆ›å»ºä¼šè¯]
    F -->|å¤±è´¥| H[æ˜¾ç¤ºé”™è¯¯]
    G --> C
    H --> D
    
    style A fill:#e1f5fe
    style C fill:#c8e6c9
    style H fill:#ffcdd2
```

### ç”¨æˆ·æ¨¡å‹è®¾è®¡
app/models/user.py
```python
from flask_sqlalchemy import SQLAlchemy
from werkzeug.security import generate_password_hash, check_password_hash
from datetime import datetime
import re

db = SQLAlchemy()

class User(db.Model):
    __tablename__ = 'users'
    
    id = db.Column(db.Integer, primary_key=True)
    username = db.Column(db.String(80), unique=True, nullable=False, index=True)
    email = db.Column(db.String(120), unique=True, nullable=False, index=True)
    password_hash = db.Column(db.String(255), nullable=False)
    
    # ç”¨æˆ·çŠ¶æ€
    is_active = db.Column(db.Boolean, default=True)
    is_verified = db.Column(db.Boolean, default=False)
    
    # æ—¶é—´æˆ³
    created_at = db.Column(db.DateTime, default=datetime.utcnow)
    last_login = db.Column(db.DateTime)
    
    # å®‰å…¨å­—æ®µ
    failed_login_attempts = db.Column(db.Integer, default=0)
    locked_until = db.Column(db.DateTime)
    
    def set_password(self, password):
        """è®¾ç½®å¯†ç å“ˆå¸Œ"""
        if not self._validate_password_strength(password):
            raise ValueError("å¯†ç å¼ºåº¦ä¸è¶³")
        self.password_hash = generate_password_hash(password)
    
    def check_password(self, password):
        """éªŒè¯å¯†ç """
        return check_password_hash(self.password_hash, password)
    
    def _validate_password_strength(self, password):
        """å¯†ç å¼ºåº¦éªŒè¯"""
        if len(password) < 8:
            return False
        if not re.search(r'[A-Z]', password):  # å¤§å†™å­—æ¯
            return False
        if not re.search(r'[a-z]', password):  # å°å†™å­—æ¯
            return False
        if not re.search(r'\d', password):     # æ•°å­—
            return False
        return True
    
    def is_locked(self):
        """æ£€æŸ¥è´¦æˆ·æ˜¯å¦è¢«é”å®š"""
        if self.locked_until and datetime.utcnow() < self.locked_until:
            return True
        return False
    
    def record_failed_login(self):
        """è®°å½•ç™»å½•å¤±è´¥"""
        self.failed_login_attempts += 1
        if self.failed_login_attempts >= 5:
            self.locked_until = datetime.utcnow() + timedelta(minutes=30)
    
    def record_successful_login(self):
        """è®°å½•æˆåŠŸç™»å½•"""
        self.last_login = datetime.utcnow()
        self.failed_login_attempts = 0
        self.locked_until = None
```

### è®¤è¯æœåŠ¡å®ç°
app/auth/service.py
```python
from flask import current_app
from app.models.user import User, db
from app.auth.session import SecureSession
import logging

class AuthService:
    @staticmethod
    def authenticate(username_or_email, password, remember_me=False):
        """ç”¨æˆ·è®¤è¯"""
        try:
            # æŸ¥æ‰¾ç”¨æˆ·
            user = User.query.filter(
                (User.username == username_or_email) | 
                (User.email == username_or_email)
            ).first()
            
            if not user:
                current_app.logger.warning(f"ç™»å½•å¤±è´¥: ç”¨æˆ·ä¸å­˜åœ¨ - {username_or_email}")
                return None, "ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯"
            
            # æ£€æŸ¥è´¦æˆ·çŠ¶æ€
            if not user.is_active:
                return None, "è´¦æˆ·å·²è¢«ç¦ç”¨"
            
            if user.is_locked():
                return None, "è´¦æˆ·å·²è¢«é”å®šï¼Œè¯·ç¨åå†è¯•"
            
            # éªŒè¯å¯†ç 
            if not user.check_password(password):
                user.record_failed_login()
                db.session.commit()
                current_app.logger.warning(f"ç™»å½•å¤±è´¥: å¯†ç é”™è¯¯ - {username_or_email}")
                return None, "ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯"
            
            # ç™»å½•æˆåŠŸ
            user.record_successful_login()
            db.session.commit()
            
            # åˆ›å»ºä¼šè¯
            SecureSession.create_session(user.id, remember_me)
            
            current_app.logger.info(f"ç”¨æˆ·ç™»å½•æˆåŠŸ: {user.username}")
            return user, None
            
        except Exception as e:
            current_app.logger.error(f"è®¤è¯è¿‡ç¨‹å‡ºé”™: {str(e)}")
            return None, "ç³»ç»Ÿé”™è¯¯ï¼Œè¯·ç¨åå†è¯•"
    
    @staticmethod
    def logout():
        """ç”¨æˆ·ç™»å‡º"""
        SecureSession.destroy_session()
        current_app.logger.info("ç”¨æˆ·å·²ç™»å‡º")
```

## ğŸ”‘ 7.3 Flask-Login æ·±å…¥åº”ç”¨

### Flask-Login é…ç½®ä¸é›†æˆ
app/__init__.py
```python
from flask import Flask
from flask_login import LoginManager
from app.models.user import User

def create_app():
    app = Flask(__name__)
    
    # åˆå§‹åŒ– Flask-Login
    login_manager = LoginManager()
    login_manager.init_app(app)
    login_manager.login_view = 'auth.login'
    login_manager.login_message = 'è¯·å…ˆç™»å½•ä»¥è®¿é—®æ­¤é¡µé¢'
    login_manager.login_message_category = 'info'
    
    @login_manager.user_loader
    def load_user(user_id):
        """ç”¨æˆ·åŠ è½½å›è°ƒ"""
        return User.query.get(int(user_id))
    
    @login_manager.unauthorized_handler
    def unauthorized():
        """æœªæˆæƒè®¿é—®å¤„ç†"""
        return redirect(url_for('auth.login', next=request.url))
    
    return app
```

### æ‰©å±•ç”¨æˆ·æ¨¡å‹
app/models/user.py
```python
from flask_login import UserMixin

class User(UserMixin, db.Model):
    # ... ä¹‹å‰çš„ä»£ç  ...
    
    def get_id(self):
        """è¿”å›ç”¨æˆ·å”¯ä¸€æ ‡è¯†"""
        return str(self.id)
    
    @property
    def is_authenticated(self):
        """ç”¨æˆ·æ˜¯å¦å·²è®¤è¯"""
        return True
    
    @property
    def is_active(self):
        """ç”¨æˆ·æ˜¯å¦æ¿€æ´»"""
        return self.is_active
    
    @property
    def is_anonymous(self):
        """æ˜¯å¦ä¸ºåŒ¿åç”¨æˆ·"""
        return False
```

### è®¤è¯è§†å›¾å®ç°
app/auth/views.py
```python
from flask import Blueprint, render_template, request, flash, redirect, url_for
from flask_login import login_user, logout_user, login_required, current_user
from app.auth.service import AuthService
from app.auth.forms import LoginForm, RegisterForm

auth_bp = Blueprint('auth', __name__, url_prefix='/auth')

@auth_bp.route('/login', methods=['GET', 'POST'])
def login():
    """ç”¨æˆ·ç™»å½•"""
    if current_user.is_authenticated:
        return redirect(url_for('main.dashboard'))
    
    form = LoginForm()
    if form.validate_on_submit():
        user, error = AuthService.authenticate(
            form.username.data,
            form.password.data,
            form.remember_me.data
        )
        
        if user:
            login_user(user, remember=form.remember_me.data)
            next_page = request.args.get('next')
            return redirect(next_page) if next_page else redirect(url_for('main.dashboard'))
        else:
            flash(error, 'error')
    
    return render_template('auth/login.html', form=form)

@auth_bp.route('/logout')
@login_required
def logout():
    """ç”¨æˆ·ç™»å‡º"""
    logout_user()
    flash('æ‚¨å·²æˆåŠŸç™»å‡º', 'success')
    return redirect(url_for('main.index'))

@auth_bp.route('/profile')
@login_required
def profile():
    """ç”¨æˆ·èµ„æ–™é¡µé¢"""
    return render_template('auth/profile.html', user=current_user)
```

## ğŸŒ 7.4 OAuth 2.0 ä¸ç¬¬ä¸‰æ–¹ç™»å½•

### OAuth 2.0 æµç¨‹å›¾

```mermaid
sequenceDiagram
    participant U as ç”¨æˆ·
    participant C as å®¢æˆ·ç«¯åº”ç”¨
    participant A as æˆæƒæœåŠ¡å™¨
    participant R as èµ„æºæœåŠ¡å™¨
    
    U->>C: 1. è¯·æ±‚ç™»å½•
    C->>A: 2. é‡å®šå‘åˆ°æˆæƒé¡µé¢
    U->>A: 3. ç”¨æˆ·æˆæƒ
    A->>C: 4. è¿”å›æˆæƒç 
    C->>A: 5. ç”¨æˆæƒç æ¢å–è®¿é—®ä»¤ç‰Œ
    A->>C: 6. è¿”å›è®¿é—®ä»¤ç‰Œ
    C->>R: 7. ä½¿ç”¨ä»¤ç‰Œè®¿é—®èµ„æº
    R->>C: 8. è¿”å›ç”¨æˆ·ä¿¡æ¯
    C->>U: 9. ç™»å½•æˆåŠŸ
```

### GitHub OAuth é›†æˆç¤ºä¾‹
app/auth/oauth.py
```python
from flask import current_app, url_for, request, session
from authlib.integrations.flask_client import OAuth
import requests

class GitHubOAuth:
    def __init__(self, app=None):
        self.oauth = OAuth()
        if app:
            self.init_app(app)
    
    def init_app(self, app):
        """åˆå§‹åŒ–OAuthé…ç½®"""
        self.oauth.init_app(app)
        
        # æ³¨å†ŒGitHub OAuth
        self.github = self.oauth.register(
            name='github',
            client_id=app.config['GITHUB_CLIENT_ID'],
            client_secret=app.config['GITHUB_CLIENT_SECRET'],
            server_metadata_url='https://api.github.com/.well-known/oauth_authorization_server',
            client_kwargs={
                'scope': 'user:email'
            }
        )
    
    def get_authorization_url(self):
        """è·å–æˆæƒURL"""
        redirect_uri = url_for('auth.github_callback', _external=True)
        return self.github.authorize_redirect(redirect_uri)
    
    def get_user_info(self, token):
        """è·å–ç”¨æˆ·ä¿¡æ¯"""
        resp = self.github.parse_id_token(token)
        user_info = self.github.get('user', token=token).json()
        
        return {
            'id': user_info['id'],
            'username': user_info['login'],
            'email': user_info.get('email'),
            'name': user_info.get('name'),
            'avatar_url': user_info.get('avatar_url')
        }

# OAuthè§†å›¾
@auth_bp.route('/github')
def github_login():
    """GitHubç™»å½•"""
    github_oauth = current_app.extensions['github_oauth']
    return github_oauth.get_authorization_url()

@auth_bp.route('/github/callback')
def github_callback():
    """GitHubå›è°ƒå¤„ç†"""
    github_oauth = current_app.extensions['github_oauth']
    token = github_oauth.github.authorize_access_token()
    
    if token:
        user_info = github_oauth.get_user_info(token)
        # å¤„ç†ç”¨æˆ·ä¿¡æ¯ï¼Œåˆ›å»ºæˆ–æ›´æ–°ç”¨æˆ·
        user = handle_oauth_user(user_info, 'github')
        login_user(user)
        return redirect(url_for('main.dashboard'))
    
    flash('GitHubç™»å½•å¤±è´¥', 'error')
    return redirect(url_for('auth.login'))
```

## ğŸ« 7.5 JWT ä»¤ç‰Œè®¤è¯

### JWT å·¥ä½œåŸç†

```mermaid
graph LR
    A[ç”¨æˆ·ç™»å½•] --> B[éªŒè¯å‡­æ®]
    B --> C[ç”ŸæˆJWT]
    C --> D[è¿”å›ç»™å®¢æˆ·ç«¯]
    D --> E[å®¢æˆ·ç«¯å­˜å‚¨JWT]
    E --> F[è¯·æ±‚æ—¶æºå¸¦JWT]
    F --> G[æœåŠ¡å™¨éªŒè¯JWT]
    G --> H[è¿”å›æ•°æ®]
    
    style C fill:#fff3e0
    style G fill:#e8f5e8
```

### JWT æœåŠ¡å®ç°
app/auth/jwt_service.py
```python
import jwt
from datetime import datetime, timedelta
from flask import current_app
from functools import wraps

class JWTService:
    @staticmethod
    def generate_token(user_id, expires_in=3600):
        """ç”ŸæˆJWTä»¤ç‰Œ"""
        payload = {
            'user_id': user_id,
            'exp': datetime.utcnow() + timedelta(seconds=expires_in),
            'iat': datetime.utcnow(),
            'iss': 'flask-app'  # å‘è¡Œè€…
        }
        
        return jwt.encode(
            payload,
            current_app.config['JWT_SECRET_KEY'],
            algorithm='HS256'
        )
    
    @staticmethod
    def verify_token(token):
        """éªŒè¯JWTä»¤ç‰Œ"""
        try:
            payload = jwt.decode(
                token,
                current_app.config['JWT_SECRET_KEY'],
                algorithms=['HS256']
            )
            return payload['user_id']
        except jwt.ExpiredSignatureError:
            return None  # ä»¤ç‰Œè¿‡æœŸ
        except jwt.InvalidTokenError:
            return None  # æ— æ•ˆä»¤ç‰Œ
    
    @staticmethod
    def refresh_token(token):
        """åˆ·æ–°ä»¤ç‰Œ"""
        try:
            payload = jwt.decode(
                token,
                current_app.config['JWT_SECRET_KEY'],
                algorithms=['HS256'],
                options={'verify_exp': False}  # å¿½ç•¥è¿‡æœŸéªŒè¯
            )
            
            # æ£€æŸ¥ä»¤ç‰Œæ˜¯å¦åœ¨åˆ·æ–°çª—å£å†…
            exp_time = datetime.fromtimestamp(payload['exp'])
            if datetime.utcnow() - exp_time > timedelta(days=7):
                return None  # è¶…å‡ºåˆ·æ–°çª—å£
            
            return JWTService.generate_token(payload['user_id'])
        except jwt.InvalidTokenError:
            return None

def jwt_required(f):
    """JWTè®¤è¯è£…é¥°å™¨"""
    @wraps(f)
    def decorated_function(*args, **kwargs):
        token = request.headers.get('Authorization')
        if not token:
            return {'error': 'ç¼ºå°‘è®¤è¯ä»¤ç‰Œ'}, 401
        
        try:
            # ç§»é™¤ 'Bearer ' å‰ç¼€
            token = token.split(' ')[1] if token.startswith('Bearer ') else token
            user_id = JWTService.verify_token(token)
            
            if not user_id:
                return {'error': 'æ— æ•ˆæˆ–è¿‡æœŸçš„ä»¤ç‰Œ'}, 401
            
            # å°†ç”¨æˆ·IDæ·»åŠ åˆ°è¯·æ±‚ä¸Šä¸‹æ–‡
            request.current_user_id = user_id
            
        except Exception as e:
            return {'error': 'ä»¤ç‰ŒéªŒè¯å¤±è´¥'}, 401
        
        return f(*args, **kwargs)
    return decorated_function
```

### APIè®¤è¯ç«¯ç‚¹
app/api/auth.py
```python
from flask import Blueprint, request, jsonify
from app.auth.service import AuthService
from app.auth.jwt_service import JWTService, jwt_required

api_auth_bp = Blueprint('api_auth', __name__, url_prefix='/api/auth')

@api_auth_bp.route('/login', methods=['POST'])
def api_login():
    """APIç™»å½•ç«¯ç‚¹"""
    data = request.get_json()
    
    if not data or not data.get('username') or not data.get('password'):
        return jsonify({'error': 'ç”¨æˆ·åå’Œå¯†ç ä¸èƒ½ä¸ºç©º'}), 400
    
    user, error = AuthService.authenticate(
        data['username'],
        data['password']
    )
    
    if user:
        token = JWTService.generate_token(user.id)
        return jsonify({
            'access_token': token,
            'token_type': 'Bearer',
            'expires_in': 3600,
            'user': {
                'id': user.id,
                'username': user.username,
                'email': user.email
            }
        })
    else:
        return jsonify({'error': error}), 401

@api_auth_bp.route('/refresh', methods=['POST'])
def refresh_token():
    """åˆ·æ–°ä»¤ç‰Œ"""
    data = request.get_json()
    old_token = data.get('refresh_token')
    
    if not old_token:
        return jsonify({'error': 'ç¼ºå°‘åˆ·æ–°ä»¤ç‰Œ'}), 400
    
    new_token = JWTService.refresh_token(old_token)
    if new_token:
        return jsonify({
            'access_token': new_token,
            'token_type': 'Bearer',
            'expires_in': 3600
        })
    else:
        return jsonify({'error': 'æ— æ•ˆçš„åˆ·æ–°ä»¤ç‰Œ'}), 401

@api_auth_bp.route('/profile', methods=['GET'])
@jwt_required
def get_profile():
    """è·å–ç”¨æˆ·èµ„æ–™"""
    user = User.query.get(request.current_user_id)
    if user:
        return jsonify({
            'id': user.id,
            'username': user.username,
            'email': user.email,
            'created_at': user.created_at.isoformat(),
            'last_login': user.last_login.isoformat() if user.last_login else None
        })
    return jsonify({'error': 'ç”¨æˆ·ä¸å­˜åœ¨'}), 404
```

## ğŸ­ 7.6 åŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶ï¼ˆRBACï¼‰

### RBAC æ¨¡å‹è®¾è®¡

```mermaid
erDiagram
    USER ||--o{ USER_ROLE : has
    ROLE ||--o{ USER_ROLE : assigned_to
    ROLE ||--o{ ROLE_PERMISSION : has
    PERMISSION ||--o{ ROLE_PERMISSION : granted_to
    
    USER {
        int id PK
        string username
        string email
        string password_hash
        boolean is_active
    }
    
    ROLE {
        int id PK
        string name
        string description
        boolean is_active
    }
    
    PERMISSION {
        int id PK
        string name
        string resource
        string action
        string description
    }
    
    USER_ROLE {
        int user_id FK
        int role_id FK
        datetime assigned_at
    }
    
    ROLE_PERMISSION {
        int role_id FK
        int permission_id FK
        datetime granted_at
    }
```

### RBAC æ¨¡å‹å®ç°
app/models/rbac.py
```python
from app.models.user import db
from datetime import datetime

# å…³è”è¡¨
user_roles = db.Table('user_roles',
    db.Column('user_id', db.Integer, db.ForeignKey('users.id'), primary_key=True),
    db.Column('role_id', db.Integer, db.ForeignKey('roles.id'), primary_key=True),
    db.Column('assigned_at', db.DateTime, default=datetime.utcnow)
)

role_permissions = db.Table('role_permissions',
    db.Column('role_id', db.Integer, db.ForeignKey('roles.id'), primary_key=True),
    db.Column('permission_id', db.Integer, db.ForeignKey('permissions.id'), primary_key=True),
    db.Column('granted_at', db.DateTime, default=datetime.utcnow)
)

class Role(db.Model):
    __tablename__ = 'roles'
    
    id = db.Column(db.Integer, primary_key=True)
    name = db.Column(db.String(80), unique=True, nullable=False)
    description = db.Column(db.Text)
    is_active = db.Column(db.Boolean, default=True)
    created_at = db.Column(db.DateTime, default=datetime.utcnow)
    
    # å…³ç³»
    permissions = db.relationship('Permission', secondary=role_permissions, backref='roles')
    
    def has_permission(self, permission_name):
        """æ£€æŸ¥è§’è‰²æ˜¯å¦æœ‰æŒ‡å®šæƒé™"""
        return any(p.name == permission_name for p in self.permissions)
    
    def __repr__(self):
        return f'<Role {self.name}>'

class Permission(db.Model):
    __tablename__ = 'permissions'
    
    id = db.Column(db.Integer, primary_key=True)
    name = db.Column(db.String(100), unique=True, nullable=False)
    resource = db.Column(db.String(50), nullable=False)  # èµ„æºç±»å‹
    action = db.Column(db.String(50), nullable=False)    # æ“ä½œç±»å‹
    description = db.Column(db.Text)
    created_at = db.Column(db.DateTime, default=datetime.utcnow)
    
    def __repr__(self):
        return f'<Permission {self.name}>'

# æ‰©å±•Useræ¨¡å‹
class User(UserMixin, db.Model):
    # ... ä¹‹å‰çš„ä»£ç  ...
    
    # æ·»åŠ è§’è‰²å…³ç³»
    roles = db.relationship('Role', secondary=user_roles, backref='users')
    
    def has_role(self, role_name):
        """æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æœ‰æŒ‡å®šè§’è‰²"""
        return any(role.name == role_name for role in self.roles)
    
    def has_permission(self, permission_name):
        """æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æœ‰æŒ‡å®šæƒé™"""
        for role in self.roles:
            if role.has_permission(permission_name):
                return True
        return False
    
    def add_role(self, role):
        """æ·»åŠ è§’è‰²"""
        if not self.has_role(role.name):
            self.roles.append(role)
    
    def remove_role(self, role):
        """ç§»é™¤è§’è‰²"""
        if self.has_role(role.name):
            self.roles.remove(role)
```

### æƒé™è£…é¥°å™¨
app/auth/decorators.py
```python
from functools import wraps
from flask import abort, request, jsonify
from flask_login import current_user

def require_permission(permission_name):
    """æƒé™æ£€æŸ¥è£…é¥°å™¨"""
    def decorator(f):
        @wraps(f)
        def decorated_function(*args, **kwargs):
            if not current_user.is_authenticated:
                if request.is_json:
                    return jsonify({'error': 'éœ€è¦ç™»å½•'}), 401
                abort(401)
            
            if not current_user.has_permission(permission_name):
                if request.is_json:
                    return jsonify({'error': 'æƒé™ä¸è¶³'}), 403
                abort(403)
            
            return f(*args, **kwargs)
        return decorated_function
    return decorator

def require_role(role_name):
    """è§’è‰²æ£€æŸ¥è£…é¥°å™¨"""
    def decorator(f):
        @wraps(f)
        def decorated_function(*args, **kwargs):
            if not current_user.is_authenticated:
                if request.is_json:
                    return jsonify({'error': 'éœ€è¦ç™»å½•'}), 401
                abort(401)
            
            if not current_user.has_role(role_name):
                if request.is_json:
                    return jsonify({'error': f'éœ€è¦{role_name}è§’è‰²'}), 403
                abort(403)
            
            return f(*args, **kwargs)
        return decorated_function
    return decorator

def require_any_role(*role_names):
    """å¤šè§’è‰²æ£€æŸ¥è£…é¥°å™¨ï¼ˆæ»¡è¶³ä»»ä¸€å³å¯ï¼‰"""
    def decorator(f):
        @wraps(f)
        def decorated_function(*args, **kwargs):
            if not current_user.is_authenticated:
                abort(401)
            
            if not any(current_user.has_role(role) for role in role_names):
                abort(403)
            
            return f(*args, **kwargs)
        return decorated_function
    return decorator
```

### ä½¿ç”¨ç¤ºä¾‹
app/admin/views.py
```python
from flask import Blueprint, render_template
from flask_login import login_required
from app.auth.decorators import require_permission, require_role

admin_bp = Blueprint('admin', __name__, url_prefix='/admin')

@admin_bp.route('/dashboard')
@login_required
@require_role('admin')
def dashboard():
    """ç®¡ç†å‘˜ä»ªè¡¨æ¿"""
    return render_template('admin/dashboard.html')

@admin_bp.route('/users')
@login_required
@require_permission('user.read')
def list_users():
    """ç”¨æˆ·åˆ—è¡¨"""
    users = User.query.all()
    return render_template('admin/users.html', users=users)

@admin_bp.route('/users/<int:user_id>/edit')
@login_required
@require_permission('user.update')
def edit_user(user_id):
    """ç¼–è¾‘ç”¨æˆ·"""
    user = User.query.get_or_404(user_id)
    return render_template('admin/edit_user.html', user=user)
```

## ğŸ” 7.7 å¤šå› ç´ è®¤è¯ï¼ˆMFAï¼‰

### MFA æµç¨‹å›¾

```mermaid
flowchart TD
    A[ç”¨æˆ·è¾“å…¥ç”¨æˆ·åå¯†ç ] --> B{ç¬¬ä¸€å› ç´ éªŒè¯}
    B -->|å¤±è´¥| C[æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯]
    B -->|æˆåŠŸ| D{MFAå·²å¯ç”¨?}
    D -->|å¦| E[ç™»å½•æˆåŠŸ]
    D -->|æ˜¯| F[å‘é€éªŒè¯ç ]
    F --> G[ç”¨æˆ·è¾“å…¥éªŒè¯ç ]
    G --> H{éªŒè¯ç æ­£ç¡®?}
    H -->|å¦| I[æ˜¾ç¤ºé”™è¯¯ï¼Œé‡æ–°è¾“å…¥]
    H -->|æ˜¯| E
    I --> G
    C --> A
    
    style E fill:#c8e6c9
    style C fill:#ffcdd2
    style I fill:#ffcdd2
```

### TOTPï¼ˆåŸºäºæ—¶é—´çš„ä¸€æ¬¡æ€§å¯†ç ï¼‰å®ç°
app/auth/mfa.py
```python
import pyotp
import qrcode
from io import BytesIO
import base64
from flask import current_app

class MFAService:
    @staticmethod
    def generate_secret():
        """ç”ŸæˆMFAå¯†é’¥"""
        return pyotp.random_base32()
    
    @staticmethod
    def generate_qr_code(user, secret):
        """ç”ŸæˆäºŒç»´ç """
        totp_uri = pyotp.totp.TOTP(secret).provisioning_uri(
            name=user.email,
            issuer_name=current_app.config.get('APP_NAME', 'Flask App')
        )
        
        qr = qrcode.QRCode(version=1, box_size=10, border=5)
        qr.add_data(totp_uri)
        qr.make(fit=True)
        
        img = qr.make_image(fill_color="black", back_color="white")
        
        # è½¬æ¢ä¸ºbase64å­—ç¬¦ä¸²
        buffer = BytesIO()
        img.save(buffer, format='PNG')
        buffer.seek(0)
        
        return base64.b64encode(buffer.getvalue()).decode()
    
    @staticmethod
    def verify_token(secret, token):
        """éªŒè¯TOTPä»¤ç‰Œ"""
        totp = pyotp.TOTP(secret)
        return totp.verify(token, valid_window=1)  # å…è®¸30ç§’è¯¯å·®
    
    @staticmethod
    def generate_backup_codes(count=10):
        """ç”Ÿæˆå¤‡ç”¨ç """
        import secrets
        import string
        
        codes = []
        for _ in range(count):
            code = ''.join(secrets.choice(string.ascii_uppercase + string.digits) 
                          for _ in range(8))
            codes.append(f"{code[:4]}-{code[4:]}")
        
        return codes

# æ‰©å±•Useræ¨¡å‹
class User(UserMixin, db.Model):
    # ... ä¹‹å‰çš„ä»£ç  ...
    
    # MFAç›¸å…³å­—æ®µ
    mfa_secret = db.Column(db.String(32))  # TOTPå¯†é’¥
    mfa_enabled = db.Column(db.Boolean, default=False)
    backup_codes = db.Column(db.Text)  # JSONæ ¼å¼å­˜å‚¨å¤‡ç”¨ç 
    
    def enable_mfa(self):
        """å¯ç”¨MFA"""
        if not self.mfa_secret:
            self.mfa_secret = MFAService.generate_secret()
        
        # ç”Ÿæˆå¤‡ç”¨ç 
        backup_codes = MFAService.generate_backup_codes()
        self.backup_codes = json.dumps(backup_codes)
        self.mfa_enabled = True
        
        return backup_codes
    
    def disable_mfa(self):
        """ç¦ç”¨MFA"""
        self.mfa_enabled = False
        self.mfa_secret = None
        self.backup_codes = None
    
    def verify_mfa_token(self, token):
        """éªŒè¯MFAä»¤ç‰Œ"""
        if not self.mfa_enabled or not self.mfa_secret:
            return False
        
        # é¦–å…ˆå°è¯•TOTPéªŒè¯
        if MFAService.verify_token(self.mfa_secret, token):
            return True
        
        # å¦‚æœTOTPå¤±è´¥ï¼Œå°è¯•å¤‡ç”¨ç 
        return self._verify_backup_code(token)
    
    def _verify_backup_code(self, code):
        """éªŒè¯å¤‡ç”¨ç """
        if not self.backup_codes:
            return False
        
        backup_codes = json.loads(self.backup_codes)
        if code in backup_codes:
            # ä½¿ç”¨åç§»é™¤å¤‡ç”¨ç 
            backup_codes.remove(code)
            self.backup_codes = json.dumps(backup_codes)
            db.session.commit()
            return True
        
        return False
```

### MFA è§†å›¾å®ç°
app/auth/mfa_views.py
```python
from flask import Blueprint, render_template, request, flash, redirect, url_for, session
from flask_login import login_required, current_user
from app.auth.mfa import MFAService
from app.models.user import db

mfa_bp = Blueprint('mfa', __name__, url_prefix='/auth/mfa')

@mfa_bp.route('/setup', methods=['GET', 'POST'])
@login_required
def setup():
    """MFAè®¾ç½®é¡µé¢"""
    if request.method == 'POST':
        token = request.form.get('token')
        
        if not current_user.mfa_secret:
            # ç”Ÿæˆæ–°çš„å¯†é’¥
            current_user.mfa_secret = MFAService.generate_secret()
            db.session.commit()
        
        # éªŒè¯ç”¨æˆ·è¾“å…¥çš„ä»¤ç‰Œ
        if MFAService.verify_token(current_user.mfa_secret, token):
            backup_codes = current_user.enable_mfa()
            db.session.commit()
            
            flash('MFAå·²æˆåŠŸå¯ç”¨ï¼è¯·ä¿å­˜ä»¥ä¸‹å¤‡ç”¨ç ï¼š', 'success')
            return render_template('auth/mfa_backup_codes.html', codes=backup_codes)
        else:
            flash('éªŒè¯ç é”™è¯¯ï¼Œè¯·é‡è¯•', 'error')
    
    # ç”ŸæˆäºŒç»´ç 
    if not current_user.mfa_secret:
        current_user.mfa_secret = MFAService.generate_secret()
        db.session.commit()
    
    qr_code = MFAService.generate_qr_code(current_user, current_user.mfa_secret)
    
    return render_template('auth/mfa_setup.html', 
                         qr_code=qr_code, 
                         secret=current_user.mfa_secret)

@mfa_bp.route('/verify', methods=['GET', 'POST'])
def verify():
    """MFAéªŒè¯é¡µé¢"""
    if 'mfa_user_id' not in session:
        return redirect(url_for('auth.login'))
    
    if request.method == 'POST':
        token = request.form.get('token')
        user_id = session.get('mfa_user_id')
        user = User.query.get(user_id)
        
        if user and user.verify_mfa_token(token):
            # MFAéªŒè¯æˆåŠŸï¼Œå®Œæˆç™»å½•
            session.pop('mfa_user_id', None)
            login_user(user, remember=session.get('remember_me', False))
            
            next_page = request.args.get('next')
            return redirect(next_page) if next_page else redirect(url_for('main.dashboard'))
        else:
            flash('éªŒè¯ç é”™è¯¯ï¼Œè¯·é‡è¯•', 'error')
    
    return render_template('auth/mfa_verify.html')

@mfa_bp.route('/disable', methods=['POST'])
@login_required
def disable():
    """ç¦ç”¨MFA"""
    password = request.form.get('password')
    
    if current_user.check_password(password):
        current_user.disable_mfa()
        db.session.commit()
        flash('MFAå·²ç¦ç”¨', 'success')
    else:
        flash('å¯†ç é”™è¯¯', 'error')
    
    return redirect(url_for('auth.profile'))
```

### ä¿®æ”¹ç™»å½•æµç¨‹æ”¯æŒMFA
app/auth/views.py
```python
# ä¿®æ”¹ç™»å½•è§†å›¾
@auth_bp.route('/login', methods=['GET', 'POST'])
def login():
    """ç”¨æˆ·ç™»å½•ï¼ˆæ”¯æŒMFAï¼‰"""
    if current_user.is_authenticated:
        return redirect(url_for('main.dashboard'))
    
    form = LoginForm()
    if form.validate_on_submit():
        user, error = AuthService.authenticate(
            form.username.data,
            form.password.data,
            form.remember_me.data
        )
        
        if user:
            # æ£€æŸ¥æ˜¯å¦å¯ç”¨äº†MFA
            if user.mfa_enabled:
                # å°†ç”¨æˆ·IDå­˜å‚¨åœ¨ä¼šè¯ä¸­ï¼Œé‡å®šå‘åˆ°MFAéªŒè¯é¡µé¢
                session['mfa_user_id'] = user.id
                session['remember_me'] = form.remember_me.data
                return redirect(url_for('mfa.verify'))
            else:
                # ç›´æ¥ç™»å½•
                login_user(user, remember=form.remember_me.data)
                next_page = request.args.get('next')
                return redirect(next_page) if next_page else redirect(url_for('main.dashboard'))
        else:
            flash(error, 'error')
    
    return render_template('auth/login.html', form=form)
```

## ğŸ“ å°ç»“

æœ¬ç« æ·±å…¥ä»‹ç»äº†Flaskä¸­ç”¨æˆ·è®¤è¯ä¸æˆæƒç³»ç»Ÿçš„å„ä¸ªæ–¹é¢ï¼š

- **ä¼šè¯ç®¡ç†**ï¼šå®‰å…¨çš„ä¼šè¯é…ç½®å’ŒCSRFé˜²æŠ¤
- **è®¤è¯ç³»ç»Ÿ**ï¼šç”¨æˆ·æ¨¡å‹è®¾è®¡å’Œè®¤è¯æœåŠ¡å®ç°
- **Flask-Login**ï¼šç®€åŒ–çš„ç”¨æˆ·ä¼šè¯ç®¡ç†
- **OAuth 2.0**ï¼šç¬¬ä¸‰æ–¹ç™»å½•é›†æˆ
- **JWTè®¤è¯**ï¼šæ— çŠ¶æ€çš„APIè®¤è¯æ–¹æ¡ˆ
- **RBAC**ï¼šçµæ´»çš„è§’è‰²æƒé™æ§åˆ¶
- **MFA**ï¼šå¤šå› ç´ è®¤è¯å¢å¼ºå®‰å…¨æ€§

è¿™äº›æŠ€æœ¯ç»„åˆä½¿ç”¨ï¼Œå¯ä»¥æ„å»ºå‡ºå®‰å…¨ã€å¯æ‰©å±•çš„ç”¨æˆ·è®¤è¯ä¸æˆæƒç³»ç»Ÿï¼Œæ»¡è¶³ä¸åŒåº”ç”¨åœºæ™¯çš„éœ€æ±‚ã€‚åœ¨å®é™…é¡¹ç›®ä¸­ï¼Œåº”æ ¹æ®å…·ä½“éœ€æ±‚é€‰æ‹©åˆé€‚çš„è®¤è¯æ–¹æ¡ˆï¼Œå¹¶å§‹ç»ˆå°†å®‰å…¨æ€§æ”¾åœ¨é¦–ä½ã€‚
        