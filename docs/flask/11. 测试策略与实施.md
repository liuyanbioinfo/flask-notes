# ğŸ§ª 11. æµ‹è¯•ç­–ç•¥ä¸å®è·µ

> ğŸ’¡ **æ ¸å¿ƒç†å¿µ**ï¼šæµ‹è¯•ä¸æ˜¯å¼€å‘å®Œæˆåçš„é™„åŠ å·¥ä½œï¼Œè€Œæ˜¯è´¯ç©¿æ•´ä¸ªå¼€å‘ç”Ÿå‘½å‘¨æœŸçš„è´¨é‡ä¿è¯æ‰‹æ®µã€‚å¥½çš„æµ‹è¯•ç­–ç•¥èƒ½å¤Ÿæé«˜ä»£ç è´¨é‡ã€é™ä½ç»´æŠ¤æˆæœ¬ã€å¢å¼ºå¼€å‘ä¿¡å¿ƒã€‚

## ğŸ”º 11.1 æµ‹è¯•é‡‘å­—å¡”ä¸æµ‹è¯•ç­–ç•¥

### æµ‹è¯•é‡‘å­—å¡”æ¨¡å‹

```mermaid
graph TD
    A["ğŸ”º æµ‹è¯•é‡‘å­—å¡”"] --> B["ğŸ” å•å…ƒæµ‹è¯• (Unit Tests)"]
    A --> C["ğŸ”— é›†æˆæµ‹è¯• (Integration Tests)"]
    A --> D["ğŸŒ ç«¯åˆ°ç«¯æµ‹è¯• (E2E Tests)"]
    
    B --> B1["âœ… å¿«é€Ÿæ‰§è¡Œ"]
    B --> B2["ğŸ’° æˆæœ¬ä½"]
    B --> B3["ğŸ¯ è¦†ç›–é¢å¹¿"]
    
    C --> C1["ğŸ”„ æ¨¡å—äº¤äº’"]
    C --> C2["âš–ï¸ å¹³è¡¡æˆæœ¬"]
    
    D --> D1["ğŸ‘¤ ç”¨æˆ·è§†è§’"]
    D --> D2["ğŸ’¸ æˆæœ¬é«˜"]
    D --> D3["ğŸŒ æ‰§è¡Œæ…¢"]
    
    style B fill:#e1f5fe
    style C fill:#fff3e0
    style D fill:#fce4ec
```

### Flask æµ‹è¯•ç­–ç•¥æ¡†æ¶
tests/conftest.py
```python
import pytest
from app import create_app, db
from app.models import User, Post

@pytest.fixture
def app():
    """åˆ›å»ºæµ‹è¯•åº”ç”¨å®ä¾‹"""
    app = create_app('testing')
    
    with app.app_context():
        db.create_all()
        yield app
        db.drop_all()

@pytest.fixture
def client(app):
    """æµ‹è¯•å®¢æˆ·ç«¯"""
    return app.test_client()

@pytest.fixture
def runner(app):
    """CLI æµ‹è¯•è¿è¡Œå™¨"""
    return app.test_cli_runner()
```

## ğŸ”¬ 11.2 å•å…ƒæµ‹è¯•ç¼–å†™

### æµ‹è¯•é©±åŠ¨å¼€å‘ (TDD) æµç¨‹

```mermaid
flowchart LR
    A["ğŸ”´ Red\nç¼–å†™å¤±è´¥æµ‹è¯•"] --> B["ğŸŸ¢ Green\nç¼–å†™æœ€å°å®ç°"] 
    B --> C["ğŸ”µ Refactor\né‡æ„ä¼˜åŒ–"]
    C --> A
    
    style A fill:#ffebee
    style B fill:#e8f5e8
    style C fill:#e3f2fd
```

### æ¨¡å‹å•å…ƒæµ‹è¯•ç¤ºä¾‹
tests/test_models.py
```python
import pytest
from app.models import User, Post
from werkzeug.security import check_password_hash

class TestUser:
    """ç”¨æˆ·æ¨¡å‹æµ‹è¯•ç±»"""
    
    def test_password_hashing(self):
        """æµ‹è¯•å¯†ç å“ˆå¸ŒåŠŸèƒ½"""
        user = User(username='testuser')
        user.set_password('secret')
        
        assert user.password_hash is not None
        assert user.password_hash != 'secret'
        assert user.check_password('secret')
        assert not user.check_password('wrong')
    
    def test_user_repr(self):
        """æµ‹è¯•ç”¨æˆ·å­—ç¬¦ä¸²è¡¨ç¤º"""
        user = User(username='john', email='john@example.com')
        assert repr(user) == '<User john>'
    
    @pytest.mark.parametrize('username,email,valid', [
        ('john', 'john@example.com', True),
        ('', 'john@example.com', False),  # ç©ºç”¨æˆ·å
        ('john', 'invalid-email', False),  # æ— æ•ˆé‚®ç®±
    ])
    def test_user_validation(self, username, email, valid):
        """å‚æ•°åŒ–æµ‹è¯•ç”¨æˆ·éªŒè¯"""
        user = User(username=username, email=email)
        assert user.is_valid() == valid
```

### è§†å›¾å‡½æ•°å•å…ƒæµ‹è¯•
tests/test_views.py
```python
import pytest
from flask import url_for
from app.models import User

class TestAuthViews:
    """è®¤è¯è§†å›¾æµ‹è¯•"""
    
    def test_register_get(self, client):
        """æµ‹è¯•æ³¨å†Œé¡µé¢GETè¯·æ±‚"""
        response = client.get('/auth/register')
        assert response.status_code == 200
        assert b'Register' in response.data
    
    def test_register_post_success(self, client, app):
        """æµ‹è¯•æˆåŠŸæ³¨å†Œ"""
        response = client.post('/auth/register', data={
            'username': 'newuser',
            'email': 'new@example.com',
            'password': 'password123',
            'password2': 'password123'
        })
        
        assert response.status_code == 302  # é‡å®šå‘
        
        with app.app_context():
            user = User.query.filter_by(username='newuser').first()
            assert user is not None
            assert user.email == 'new@example.com'
    
    def test_login_required_decorator(self, client):
        """æµ‹è¯•ç™»å½•è£…é¥°å™¨"""
        response = client.get('/dashboard')
        assert response.status_code == 302
        assert '/auth/login' in response.location
```

## ğŸ”— 11.3 é›†æˆæµ‹è¯•ä¸ç«¯åˆ°ç«¯æµ‹è¯•

### æ•°æ®åº“é›†æˆæµ‹è¯•
tests/test_integration.py
```python
import pytest
from app import db
from app.models import User, Post
from app.services import PostService

class TestPostService:
    """æ–‡ç« æœåŠ¡é›†æˆæµ‹è¯•"""
    
    @pytest.fixture
    def user(self, app):
        """åˆ›å»ºæµ‹è¯•ç”¨æˆ·"""
        with app.app_context():
            user = User(username='author', email='author@example.com')
            user.set_password('password')
            db.session.add(user)
            db.session.commit()
            return user
    
    def test_create_post_with_tags(self, app, user):
        """æµ‹è¯•åˆ›å»ºå¸¦æ ‡ç­¾çš„æ–‡ç« """
        with app.app_context():
            post_data = {
                'title': 'Test Post',
                'content': 'This is a test post',
                'tags': ['python', 'flask', 'testing']
            }
            
            post = PostService.create_post(user.id, post_data)
            
            assert post.title == 'Test Post'
            assert len(post.tags) == 3
            assert 'python' in [tag.name for tag in post.tags]
    
    def test_post_search_functionality(self, app, user):
        """æµ‹è¯•æ–‡ç« æœç´¢åŠŸèƒ½"""
        with app.app_context():
            # åˆ›å»ºæµ‹è¯•æ•°æ®
            posts = [
                Post(title='Python Tutorial', content='Learn Python', author=user),
                Post(title='Flask Guide', content='Learn Flask', author=user),
                Post(title='JavaScript Basics', content='Learn JS', author=user)
            ]
            
            for post in posts:
                db.session.add(post)
            db.session.commit()
            
            # æµ‹è¯•æœç´¢
            results = PostService.search_posts('Python')
            assert len(results) == 1
            assert results[0].title == 'Python Tutorial'
```

### API ç«¯åˆ°ç«¯æµ‹è¯•
tests/test_api_e2e.py
```python
import pytest
import json
from app.models import User

class TestBlogAPI:
    """åšå®¢APIç«¯åˆ°ç«¯æµ‹è¯•"""
    
    @pytest.fixture
    def auth_headers(self, client, app):
        """è·å–è®¤è¯å¤´"""
        with app.app_context():
            # åˆ›å»ºç”¨æˆ·
            user = User(username='apiuser', email='api@example.com')
            user.set_password('password')
            db.session.add(user)
            db.session.commit()
            
            # ç™»å½•è·å–token
            response = client.post('/api/auth/login', json={
                'username': 'apiuser',
                'password': 'password'
            })
            
            token = response.json['access_token']
            return {'Authorization': f'Bearer {token}'}
    
    def test_complete_blog_workflow(self, client, auth_headers):
        """æµ‹è¯•å®Œæ•´çš„åšå®¢å·¥ä½œæµç¨‹"""
        # 1. åˆ›å»ºæ–‡ç« 
        post_data = {
            'title': 'My First Post',
            'content': 'This is my first blog post',
            'tags': ['first', 'blog']
        }
        
        response = client.post('/api/posts', 
                             json=post_data, 
                             headers=auth_headers)
        assert response.status_code == 201
        post_id = response.json['id']
        
        # 2. è·å–æ–‡ç« 
        response = client.get(f'/api/posts/{post_id}')
        assert response.status_code == 200
        assert response.json['title'] == 'My First Post'
        
        # 3. æ›´æ–°æ–‡ç« 
        update_data = {'title': 'My Updated Post'}
        response = client.put(f'/api/posts/{post_id}', 
                            json=update_data, 
                            headers=auth_headers)
        assert response.status_code == 200
        
        # 4. åˆ é™¤æ–‡ç« 
        response = client.delete(f'/api/posts/{post_id}', 
                               headers=auth_headers)
        assert response.status_code == 204
        
        # 5. éªŒè¯åˆ é™¤
        response = client.get(f'/api/posts/{post_id}')
        assert response.status_code == 404
```

## ğŸ“‹ 11.4 æµ‹è¯•æ•°æ®ç®¡ç†

### Factory Boy æ•°æ®å·¥å‚
tests/factories.py
```python
import factory
from factory.alchemy import SQLAlchemyModelFactory
from app import db
from app.models import User, Post, Tag

class UserFactory(SQLAlchemyModelFactory):
    """ç”¨æˆ·æ•°æ®å·¥å‚"""
    class Meta:
        model = User
        sqlalchemy_session = db.session
        sqlalchemy_session_persistence = 'commit'
    
    username = factory.Sequence(lambda n: f'user{n}')
    email = factory.LazyAttribute(lambda obj: f'{obj.username}@example.com')
    password_hash = factory.PostGenerationMethodCall('set_password', 'password123')
    is_active = True

class PostFactory(SQLAlchemyModelFactory):
    """æ–‡ç« æ•°æ®å·¥å‚"""
    class Meta:
        model = Post
        sqlalchemy_session = db.session
        sqlalchemy_session_persistence = 'commit'
    
    title = factory.Faker('sentence', nb_words=4)
    content = factory.Faker('text', max_nb_chars=500)
    author = factory.SubFactory(UserFactory)
    
    @factory.post_generation
    def tags(self, create, extracted, **kwargs):
        if not create:
            return
        
        if extracted:
            for tag_name in extracted:
                tag = Tag.query.filter_by(name=tag_name).first()
                if not tag:
                    tag = Tag(name=tag_name)
                    db.session.add(tag)
                self.tags.append(tag)
```

### ä½¿ç”¨æ•°æ®å·¥å‚çš„æµ‹è¯•
tests/test_with_factories.py
```python
import pytest
from tests.factories import UserFactory, PostFactory

class TestWithFactories:
    """ä½¿ç”¨æ•°æ®å·¥å‚çš„æµ‹è¯•"""
    
    def test_user_creation(self, app):
        """æµ‹è¯•ç”¨æˆ·åˆ›å»º"""
        with app.app_context():
            user = UserFactory()
            assert user.username.startswith('user')
            assert '@example.com' in user.email
    
    def test_post_with_tags(self, app):
        """æµ‹è¯•å¸¦æ ‡ç­¾çš„æ–‡ç« """
        with app.app_context():
            post = PostFactory(tags=['python', 'flask'])
            assert len(post.tags) == 2
            tag_names = [tag.name for tag in post.tags]
            assert 'python' in tag_names
            assert 'flask' in tag_names
    
    def test_batch_creation(self, app):
        """æµ‹è¯•æ‰¹é‡åˆ›å»º"""
        with app.app_context():
            users = UserFactory.create_batch(5)
            posts = PostFactory.create_batch(10, author=users[0])
            
            assert len(users) == 5
            assert len(posts) == 10
            assert all(post.author == users[0] for post in posts)
```

## ğŸ­ 11.5 Mock ä¸ Fixture ä½¿ç”¨

### Mock å¤–éƒ¨æœåŠ¡
tests/test_mocking.py
```python
import pytest
from unittest.mock import Mock, patch, MagicMock
from app.services import EmailService, PaymentService

class TestEmailService:
    """é‚®ä»¶æœåŠ¡æµ‹è¯•"""
    
    @patch('app.services.email.send_mail')
    def test_send_welcome_email(self, mock_send_mail, app):
        """æµ‹è¯•å‘é€æ¬¢è¿é‚®ä»¶"""
        with app.app_context():
            user = UserFactory()
            
            EmailService.send_welcome_email(user)
            
            mock_send_mail.assert_called_once()
            args, kwargs = mock_send_mail.call_args
            assert user.email in args
            assert 'Welcome' in kwargs.get('subject', '')
    
    @patch('requests.post')
    def test_payment_processing(self, mock_post, app):
        """æµ‹è¯•æ”¯ä»˜å¤„ç†"""
        # æ¨¡æ‹ŸæˆåŠŸå“åº”
        mock_response = Mock()
        mock_response.status_code = 200
        mock_response.json.return_value = {
            'status': 'success',
            'transaction_id': 'txn_123456'
        }
        mock_post.return_value = mock_response
        
        with app.app_context():
            result = PaymentService.process_payment({
                'amount': 100.00,
                'currency': 'USD',
                'card_token': 'tok_visa'
            })
            
            assert result['status'] == 'success'
            assert 'transaction_id' in result
            mock_post.assert_called_once()
```

### é«˜çº§ Fixture ä½¿ç”¨
tests/conftest.py
```python
import pytest
from unittest.mock import patch
from app.services import CacheService

@pytest.fixture(scope='session')
def redis_mock():
    """ä¼šè¯çº§åˆ«çš„Redisæ¨¡æ‹Ÿ"""
    with patch('app.extensions.redis_client') as mock_redis:
        # æ¨¡æ‹ŸRedisè¡Œä¸º
        cache = {}
        
        def mock_get(key):
            return cache.get(key)
        
        def mock_set(key, value, ex=None):
            cache[key] = value
            return True
        
        def mock_delete(key):
            return cache.pop(key, None) is not None
        
        mock_redis.get.side_effect = mock_get
        mock_redis.set.side_effect = mock_set
        mock_redis.delete.side_effect = mock_delete
        
        yield mock_redis

@pytest.fixture
def authenticated_user(client, app):
    """å·²è®¤è¯ç”¨æˆ·fixture"""
    with app.app_context():
        user = UserFactory()
        
        with client.session_transaction() as sess:
            sess['user_id'] = user.id
            sess['_fresh'] = True
        
        return user
```

## ğŸ“ˆ 11.6 æµ‹è¯•è¦†ç›–ç‡åˆ†æ

### é…ç½®æµ‹è¯•è¦†ç›–ç‡
.coveragerc
```python
[run]
source = app
omit = 
    app/__init__.py
    app/config.py
    */venv/*
    */migrations/*
    */tests/*

[report]
exclude_lines =
    pragma: no cover
    def __repr__
    raise AssertionError
    raise NotImplementedError

[html]
directory = htmlcov
```

### è¦†ç›–ç‡æµ‹è¯•å‘½ä»¤

```bash
# è¿è¡Œæµ‹è¯•å¹¶ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š
pytest --cov=app --cov-report=html --cov-report=term-missing

# æŸ¥çœ‹è¯¦ç»†è¦†ç›–ç‡
coverage report -m

# ç”ŸæˆHTMLæŠ¥å‘Š
coverage html
```

### è¦†ç›–ç‡åˆ†ææµç¨‹

```mermaid
flowchart TD
    A["ğŸ§ª è¿è¡Œæµ‹è¯•"] --> B["ğŸ“Š æ”¶é›†è¦†ç›–ç‡æ•°æ®"]
    B --> C["ğŸ“ˆ ç”ŸæˆæŠ¥å‘Š"]
    C --> D{"è¦†ç›–ç‡ >= 80%?"}
    D -->|æ˜¯| E["âœ… é€šè¿‡æ£€æŸ¥"]
    D -->|å¦| F["âŒ éœ€è¦è¡¥å……æµ‹è¯•"]
    F --> G["ğŸ” è¯†åˆ«æœªè¦†ç›–ä»£ç "]
    G --> H["âœï¸ ç¼–å†™æµ‹è¯•"]
    H --> A
    
    style E fill:#e8f5e8
    style F fill:#ffebee
```

## âš¡ 11.7 æ€§èƒ½æµ‹è¯•ä¸å‹åŠ›æµ‹è¯•

### ä½¿ç”¨ pytest-benchmark
tests/test_performance.py
```python
import pytest
from app.services import SearchService
from tests.factories import PostFactory

class TestPerformance:
    """æ€§èƒ½æµ‹è¯•"""
    
    @pytest.fixture(scope='class')
    def large_dataset(self, app):
        """åˆ›å»ºå¤§æ•°æ®é›†"""
        with app.app_context():
            posts = PostFactory.create_batch(1000)
            return posts
    
    def test_search_performance(self, benchmark, app, large_dataset):
        """æµ‹è¯•æœç´¢æ€§èƒ½"""
        with app.app_context():
            result = benchmark(SearchService.search_posts, 'python')
            assert len(result) > 0
    
    def test_pagination_performance(self, benchmark, app, large_dataset):
        """æµ‹è¯•åˆ†é¡µæ€§èƒ½"""
        with app.app_context():
            result = benchmark(
                SearchService.get_posts_paginated, 
                page=1, 
                per_page=20
            )
            assert result.total > 0
```

### ä½¿ç”¨ Locust è¿›è¡Œå‹åŠ›æµ‹è¯•
locustfile.py
```python
from locust import HttpUser, task, between
import random

class BlogUser(HttpUser):
    """åšå®¢ç”¨æˆ·è¡Œä¸ºæ¨¡æ‹Ÿ"""
    wait_time = between(1, 3)
    
    def on_start(self):
        """ç”¨æˆ·å¼€å§‹æ—¶çš„è¡Œä¸º"""
        # ç™»å½•
        response = self.client.post('/auth/login', {
            'username': 'testuser',
            'password': 'password'
        })
        
    @task(3)
    def view_posts(self):
        """æµè§ˆæ–‡ç«  - é«˜é¢‘æ“ä½œ"""
        self.client.get('/posts')
        
        # éšæœºæŸ¥çœ‹å…·ä½“æ–‡ç« 
        post_id = random.randint(1, 100)
        self.client.get(f'/posts/{post_id}')
    
    @task(1)
    def create_post(self):
        """åˆ›å»ºæ–‡ç«  - ä½é¢‘æ“ä½œ"""
        self.client.post('/posts', {
            'title': f'Test Post {random.randint(1, 1000)}',
            'content': 'This is a test post content'
        })
    
    @task(2)
    def search_posts(self):
        """æœç´¢æ–‡ç«  - ä¸­é¢‘æ“ä½œ"""
        keywords = ['python', 'flask', 'web', 'api', 'database']
        keyword = random.choice(keywords)
        self.client.get(f'/search?q={keyword}')
```

### æ€§èƒ½ç›‘æ§ä¸åˆ†æ
tests/test_monitoring.py
```python
import time
import psutil
import pytest
from app import create_app

class TestResourceUsage:
    """èµ„æºä½¿ç”¨æµ‹è¯•"""
    
    def test_memory_usage(self, app):
        """æµ‹è¯•å†…å­˜ä½¿ç”¨"""
        process = psutil.Process()
        initial_memory = process.memory_info().rss
        
        # æ‰§è¡Œå¤§é‡æ“ä½œ
        with app.app_context():
            posts = PostFactory.create_batch(100)
            
        final_memory = process.memory_info().rss
        memory_increase = final_memory - initial_memory
        
        # å†…å­˜å¢é•¿ä¸åº”è¶…è¿‡50MB
        assert memory_increase < 50 * 1024 * 1024
    
    def test_response_time(self, client):
        """æµ‹è¯•å“åº”æ—¶é—´"""
        start_time = time.time()
        response = client.get('/posts')
        end_time = time.time()
        
        response_time = end_time - start_time
        
        assert response.status_code == 200
        assert response_time < 1.0  # å“åº”æ—¶é—´åº”å°äº1ç§’
```

## ğŸ¯ æµ‹è¯•æœ€ä½³å®è·µæ€»ç»“

### æµ‹è¯•åŸåˆ™ FIRST

```mermaid
mindmap
  root((FIRST åŸåˆ™))
    Fast
      å¿«é€Ÿæ‰§è¡Œ
      ç§’çº§åé¦ˆ
    Independent
      æµ‹è¯•ç‹¬ç«‹
      æ— ä¾èµ–å…³ç³»
    Repeatable
      å¯é‡å¤æ‰§è¡Œ
      ç»“æœä¸€è‡´
    Self-Validating
      è‡ªæˆ‘éªŒè¯
      æ˜ç¡®ç»“æœ
    Timely
      åŠæ—¶ç¼–å†™
      ä¸å¼€å‘åŒæ­¥
```

### æµ‹è¯•å‘½åçº¦å®š

```python
# âœ… å¥½çš„æµ‹è¯•å‘½å
def test_user_login_with_valid_credentials_should_return_success():
    pass

def test_user_login_with_invalid_password_should_return_error():
    pass

def test_post_creation_without_title_should_raise_validation_error():
    pass

# âŒ ä¸å¥½çš„æµ‹è¯•å‘½å
def test_login():
    pass

def test_user():
    pass
```

### æŒç»­é›†æˆé…ç½®
.github/workflows/test.yml
```yaml
name: Tests

on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:13
        env:
          POSTGRES_PASSWORD: postgres
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    
    steps:
    - uses: actions/checkout@v2
    
    - name: Set up Python
      uses: actions/setup-python@v2
      with:
        python-version: 3.9
    
    - name: Install dependencies
      run: |
        pip install -r requirements.txt
        pip install pytest pytest-cov
    
    - name: Run tests
      run: |
        pytest --cov=app --cov-report=xml
    
    - name: Upload coverage
      uses: codecov/codecov-action@v1
```

é€šè¿‡ç³»ç»Ÿæ€§çš„æµ‹è¯•ç­–ç•¥ï¼Œæˆ‘ä»¬èƒ½å¤Ÿæ„å»ºé«˜è´¨é‡ã€å¯ç»´æŠ¤çš„Flaskåº”ç”¨ã€‚æµ‹è¯•ä¸ä»…æ˜¯è´¨é‡ä¿è¯çš„æ‰‹æ®µï¼Œæ›´æ˜¯è®¾è®¡è‰¯å¥½ä»£ç æ¶æ„çš„é©±åŠ¨åŠ›ã€‚åœ¨ä¸‹ä¸€ç« ä¸­ï¼Œæˆ‘ä»¬å°†æ¢è®¨ä»£ç è´¨é‡ä¸è§„èŒƒï¼Œè¿›ä¸€æ­¥æå‡å¼€å‘æ•ˆç‡å’Œä»£ç å¯ç»´æŠ¤æ€§ã€‚
        