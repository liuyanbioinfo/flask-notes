# 9. ğŸ—ï¸ åº”ç”¨æ¶æ„ä¸æ¨¡å—åŒ–

åœ¨Flaskåº”ç”¨çš„å‘å±•è¿‡ç¨‹ä¸­ï¼Œéšç€åŠŸèƒ½çš„å¢åŠ å’Œå›¢é˜Ÿçš„æ‰©å¤§ï¼Œè‰¯å¥½çš„æ¶æ„è®¾è®¡å˜å¾—è‡³å…³é‡è¦ã€‚æœ¬ç« å°†æ·±å…¥æ¢è®¨å¦‚ä½•æ„å»ºå¯ç»´æŠ¤ã€å¯æ‰©å±•çš„Flaskåº”ç”¨æ¶æ„ã€‚

## ğŸ“‹ 9.1 è“å›¾ï¼ˆBlueprintsï¼‰é«˜çº§ç”¨æ³•

### ğŸ¯ æ ¸å¿ƒæ¦‚å¿µ

è“å›¾æ˜¯Flaskæä¾›çš„åº”ç”¨æ¨¡å—åŒ–æœºåˆ¶ï¼Œå…è®¸æˆ‘ä»¬å°†å¤§å‹åº”ç”¨æ‹†åˆ†ä¸ºæ›´å°ã€æ›´æ˜“ç®¡ç†çš„ç»„ä»¶ã€‚

```mermaid
graph TD
    A[Flaskåº”ç”¨] --> B[ç”¨æˆ·æ¨¡å—è“å›¾]
    A --> C[åšå®¢æ¨¡å—è“å›¾]
    A --> D[APIæ¨¡å—è“å›¾]
    B --> B1[ç”¨æˆ·æ³¨å†Œ]
    B --> B2[ç”¨æˆ·ç™»å½•]
    B --> B3[ç”¨æˆ·èµ„æ–™]
    C --> C1[æ–‡ç« åˆ—è¡¨]
    C --> C2[æ–‡ç« è¯¦æƒ…]
    C --> C3[æ–‡ç« ç¼–è¾‘]
    D --> D1[RESTful API]
    D --> D2[GraphQL API]
```

### ğŸ’¡ åŸºç¡€è“å›¾å®ç°
app/blueprints/auth.py
```python
from flask import Blueprint, render_template, request, flash, redirect, url_for
from werkzeug.security import check_password_hash

# åˆ›å»ºè®¤è¯è“å›¾
auth_bp = Blueprint('auth', __name__, url_prefix='/auth')

@auth_bp.route('/login', methods=['GET', 'POST'])
def login():
    if request.method == 'POST':
        username = request.form['username']
        password = request.form['password']
        # éªŒè¯é€»è¾‘
        if validate_user(username, password):
            return redirect(url_for('main.dashboard'))
        flash('Invalid credentials')
    return render_template('auth/login.html')

@auth_bp.route('/register', methods=['GET', 'POST'])
def register():
    # æ³¨å†Œé€»è¾‘
    pass
```

### ğŸ”§ é«˜çº§è“å›¾ç‰¹æ€§

#### 1. åµŒå¥—è“å›¾ç»“æ„
app/blueprints/__init__.py
```python
from flask import Blueprint

# ä¸»APIè“å›¾
api_bp = Blueprint('api', __name__, url_prefix='/api')

# ç‰ˆæœ¬åŒ–APIè“å›¾
api_v1_bp = Blueprint('api_v1', __name__, url_prefix='/v1')
api_v2_bp = Blueprint('api_v2', __name__, url_prefix='/v2')

# æ³¨å†Œå­è“å›¾åˆ°ä¸»è“å›¾
api_bp.register_blueprint(api_v1_bp)
api_bp.register_blueprint(api_v2_bp)
```

#### 2. è“å›¾å·¥å‚æ¨¡å¼
app/blueprints/blog.py
```python
def create_blog_blueprint(config=None):
    """è“å›¾å·¥å‚å‡½æ•°"""
    blog_bp = Blueprint('blog', __name__, url_prefix='/blog')
    
    # æ ¹æ®é…ç½®åŠ¨æ€æ·»åŠ è·¯ç”±
    if config and config.get('ENABLE_COMMENTS'):
        @blog_bp.route('/post/<int:id>/comments')
        def post_comments(id):
            # è¯„è®ºåŠŸèƒ½
            pass
    
    return blog_bp
```

## ğŸ­ 9.2 åº”ç”¨å·¥å‚ä¸ä¾èµ–æ³¨å…¥

### ğŸ¯ åº”ç”¨å·¥å‚æ¨¡å¼

åº”ç”¨å·¥å‚æ¨¡å¼æ˜¯åˆ›å»ºFlaskåº”ç”¨çš„æœ€ä½³å®è·µï¼Œå®ƒæä¾›äº†æ›´å¥½çš„æµ‹è¯•æ€§å’Œé…ç½®çµæ´»æ€§ã€‚

```mermaid
flowchart LR
    A[é…ç½®æ–‡ä»¶] --> B[åº”ç”¨å·¥å‚]
    C[æ‰©å±•æ³¨å†Œ] --> B
    D[è“å›¾æ³¨å†Œ] --> B
    B --> E[Flaskåº”ç”¨å®ä¾‹]
    E --> F[WSGIæœåŠ¡å™¨]
```

### ğŸ’¡ å®Œæ•´åº”ç”¨å·¥å‚å®ç°
app/__init__.py
```python
from flask import Flask
from flask_sqlalchemy import SQLAlchemy
from flask_login import LoginManager
from flask_mail import Mail

# æ‰©å±•å®ä¾‹
db = SQLAlchemy()
login_manager = LoginManager()
mail = Mail()

def create_app(config_name='development'):
    """åº”ç”¨å·¥å‚å‡½æ•°"""
    app = Flask(__name__)
    
    # åŠ è½½é…ç½®
    app.config.from_object(f'config.{config_name.title()}Config')
    
    # åˆå§‹åŒ–æ‰©å±•
    init_extensions(app)
    
    # æ³¨å†Œè“å›¾
    register_blueprints(app)
    
    # æ³¨å†Œé”™è¯¯å¤„ç†å™¨
    register_error_handlers(app)
    
    return app

def init_extensions(app):
    """åˆå§‹åŒ–Flaskæ‰©å±•"""
    db.init_app(app)
    login_manager.init_app(app)
    mail.init_app(app)
    
    # é…ç½®ç™»å½•ç®¡ç†å™¨
    login_manager.login_view = 'auth.login'
    login_manager.login_message = 'è¯·å…ˆç™»å½•è®¿é—®æ­¤é¡µé¢'

def register_blueprints(app):
    """æ³¨å†Œè“å›¾"""
    from app.blueprints.auth import auth_bp
    from app.blueprints.blog import blog_bp
    from app.blueprints.api import api_bp
    
    app.register_blueprint(auth_bp)
    app.register_blueprint(blog_bp)
    app.register_blueprint(api_bp)
```

### ğŸ”§ ä¾èµ–æ³¨å…¥å®ç°
app/services/__init__.py
```python
class ServiceContainer:
    """ç®€å•çš„ä¾èµ–æ³¨å…¥å®¹å™¨"""
    
    def __init__(self):
        self._services = {}
        self._singletons = {}
    
    def register(self, name, factory, singleton=False):
        """æ³¨å†ŒæœåŠ¡"""
        self._services[name] = {
            'factory': factory,
            'singleton': singleton
        }
    
    def get(self, name):
        """è·å–æœåŠ¡å®ä¾‹"""
        if name not in self._services:
            raise ValueError(f"Service '{name}' not registered")
        
        service_config = self._services[name]
        
        if service_config['singleton']:
            if name not in self._singletons:
                self._singletons[name] = service_config['factory']()
            return self._singletons[name]
        
        return service_config['factory']()

# å…¨å±€å®¹å™¨å®ä¾‹
container = ServiceContainer()
```

## ğŸ”Œ 9.3 æ’ä»¶ç³»ç»Ÿè®¾è®¡

### ğŸ¯ æ’ä»¶æ¶æ„æ¦‚å¿µ

æ’ä»¶ç³»ç»Ÿå…è®¸åº”ç”¨åœ¨è¿è¡Œæ—¶åŠ¨æ€åŠ è½½å’Œå¸è½½åŠŸèƒ½æ¨¡å—ï¼Œæä¾›äº†æå¤§çš„æ‰©å±•æ€§ã€‚

```mermaid
graph TB
    A[Flaskåº”ç”¨æ ¸å¿ƒ] --> B[æ’ä»¶ç®¡ç†å™¨]
    B --> C[æ’ä»¶A: æ”¯ä»˜ç³»ç»Ÿ]
    B --> D[æ’ä»¶B: é‚®ä»¶æœåŠ¡]
    B --> E[æ’ä»¶C: ç¼“å­˜ç³»ç»Ÿ]
    C --> C1[æ”¯ä»˜å®]
    C --> C2[å¾®ä¿¡æ”¯ä»˜]
    D --> D1[SMTP]
    D --> D2[SendGrid]
    E --> E1[Redis]
    E --> E2[Memcached]
```

### ğŸ’¡ æ’ä»¶åŸºç±»è®¾è®¡
app/plugins/base.py
```python
from abc import ABC, abstractmethod
from flask import current_app

class BasePlugin(ABC):
    """æ’ä»¶åŸºç±»"""
    
    def __init__(self, app=None):
        self.app = app
        if app is not None:
            self.init_app(app)
    
    @abstractmethod
    def init_app(self, app):
        """åˆå§‹åŒ–æ’ä»¶"""
        pass
    
    @abstractmethod
    def get_name(self):
        """è·å–æ’ä»¶åç§°"""
        pass
    
    @abstractmethod
    def get_version(self):
        """è·å–æ’ä»¶ç‰ˆæœ¬"""
        pass
    
    def before_request(self):
        """è¯·æ±‚å‰é’©å­"""
        pass
    
    def after_request(self, response):
        """è¯·æ±‚åé’©å­"""
        return response
```

### ğŸ”§ æ’ä»¶ç®¡ç†å™¨å®ç°
app/plugins/manager.py
```python
import importlib
import os
from flask import current_app

class PluginManager:
    """æ’ä»¶ç®¡ç†å™¨"""
    
    def __init__(self, app=None):
        self.plugins = {}
        if app is not None:
            self.init_app(app)
    
    def init_app(self, app):
        """åˆå§‹åŒ–æ’ä»¶ç®¡ç†å™¨"""
        app.plugin_manager = self
        
        # æ³¨å†Œé’©å­
        app.before_request(self._before_request)
        app.after_request(self._after_request)
    
    def load_plugin(self, plugin_name):
        """åŠ è½½æ’ä»¶"""
        try:
            module = importlib.import_module(f'app.plugins.{plugin_name}')
            plugin_class = getattr(module, f'{plugin_name.title()}Plugin')
            plugin = plugin_class(current_app)
            
            self.plugins[plugin_name] = plugin
            current_app.logger.info(f'Plugin {plugin_name} loaded successfully')
            
        except Exception as e:
            current_app.logger.error(f'Failed to load plugin {plugin_name}: {e}')
    
    def unload_plugin(self, plugin_name):
        """å¸è½½æ’ä»¶"""
        if plugin_name in self.plugins:
            del self.plugins[plugin_name]
            current_app.logger.info(f'Plugin {plugin_name} unloaded')
    
    def _before_request(self):
        """æ‰§è¡Œæ‰€æœ‰æ’ä»¶çš„before_requesté’©å­"""
        for plugin in self.plugins.values():
            plugin.before_request()
    
    def _after_request(self, response):
        """æ‰§è¡Œæ‰€æœ‰æ’ä»¶çš„after_requesté’©å­"""
        for plugin in self.plugins.values():
            response = plugin.after_request(response)
        return response
```

## ğŸ“¡ 9.4 äº‹ä»¶é©±åŠ¨æ¶æ„

### ğŸ¯ äº‹ä»¶ç³»ç»Ÿæ¦‚å¿µ

äº‹ä»¶é©±åŠ¨æ¶æ„é€šè¿‡äº‹ä»¶çš„å‘å¸ƒå’Œè®¢é˜…å®ç°ç»„ä»¶é—´çš„æ¾è€¦åˆé€šä¿¡ã€‚

```mermaid
sequenceDiagram
    participant U as ç”¨æˆ·æ“ä½œ
    participant C as æ§åˆ¶å™¨
    participant E as äº‹ä»¶ç³»ç»Ÿ
    participant L as æ—¥å¿—æœåŠ¡
    participant M as é‚®ä»¶æœåŠ¡
    participant N as é€šçŸ¥æœåŠ¡
    
    U->>C: ç”¨æˆ·æ³¨å†Œ
    C->>E: å‘å¸ƒç”¨æˆ·æ³¨å†Œäº‹ä»¶
    E->>L: è®°å½•æ³¨å†Œæ—¥å¿—
    E->>M: å‘é€æ¬¢è¿é‚®ä»¶
    E->>N: å‘é€ç³»ç»Ÿé€šçŸ¥
    C->>U: è¿”å›æ³¨å†Œç»“æœ
```

### ğŸ’¡ äº‹ä»¶ç³»ç»Ÿå®ç°
app/events/__init__.py
```python
from typing import Dict, List, Callable
from functools import wraps

class EventManager:
    """äº‹ä»¶ç®¡ç†å™¨"""
    
    def __init__(self):
        self._listeners: Dict[str, List[Callable]] = {}
    
    def listen(self, event_name: str, listener: Callable):
        """æ³¨å†Œäº‹ä»¶ç›‘å¬å™¨"""
        if event_name not in self._listeners:
            self._listeners[event_name] = []
        self._listeners[event_name].append(listener)
    
    def emit(self, event_name: str, **kwargs):
        """è§¦å‘äº‹ä»¶"""
        if event_name in self._listeners:
            for listener in self._listeners[event_name]:
                try:
                    listener(**kwargs)
                except Exception as e:
                    # è®°å½•é”™è¯¯ä½†ä¸ä¸­æ–­å…¶ä»–ç›‘å¬å™¨
                    print(f"Error in event listener: {e}")
    
    def decorator(self, event_name: str):
        """äº‹ä»¶ç›‘å¬å™¨è£…é¥°å™¨"""
        def wrapper(func):
            self.listen(event_name, func)
            return func
        return wrapper

# å…¨å±€äº‹ä»¶ç®¡ç†å™¨
events = EventManager()
```

### ğŸ”§ äº‹ä»¶ä½¿ç”¨ç¤ºä¾‹
app/services/user_service.py
```python
from app.events import events
from app.models import User

class UserService:
    """ç”¨æˆ·æœåŠ¡"""
    
    def register_user(self, username, email, password):
        """ç”¨æˆ·æ³¨å†Œ"""
        user = User(username=username, email=email)
        user.set_password(password)
        user.save()
        
        # è§¦å‘ç”¨æˆ·æ³¨å†Œäº‹ä»¶
        events.emit('user.registered', user=user)
        
        return user

# äº‹ä»¶ç›‘å¬å™¨
@events.decorator('user.registered')
def send_welcome_email(user):
    """å‘é€æ¬¢è¿é‚®ä»¶"""
    from app.services.mail_service import send_email
    send_email(
        to=user.email,
        subject='æ¬¢è¿æ³¨å†Œï¼',
        template='emails/welcome.html',
        user=user
    )

@events.decorator('user.registered')
def log_user_registration(user):
    """è®°å½•ç”¨æˆ·æ³¨å†Œæ—¥å¿—"""
    from flask import current_app
    current_app.logger.info(f'New user registered: {user.username}')
```

## ğŸ“¬ 9.5 æ¶ˆæ¯é˜Ÿåˆ—é›†æˆï¼ˆCeleryã€RQï¼‰

### ğŸ¯ å¼‚æ­¥ä»»åŠ¡æ¶æ„

æ¶ˆæ¯é˜Ÿåˆ—å…è®¸æˆ‘ä»¬å°†è€—æ—¶ä»»åŠ¡å¼‚æ­¥å¤„ç†ï¼Œæé«˜åº”ç”¨å“åº”æ€§èƒ½ã€‚

```mermaid
graph LR
    A[Webè¯·æ±‚] --> B[Flaskåº”ç”¨]
    B --> C[ä»»åŠ¡é˜Ÿåˆ—]
    C --> D[Workerè¿›ç¨‹1]
    C --> E[Workerè¿›ç¨‹2]
    C --> F[Workerè¿›ç¨‹3]
    D --> G[Redis/RabbitMQ]
    E --> G
    F --> G
    B --> H[ç«‹å³å“åº”]
```

### ğŸ’¡ Celeryé›†æˆ
app/tasks/__init__.py
```python
from celery import Celery
from flask import current_app

def make_celery(app):
    """åˆ›å»ºCeleryå®ä¾‹"""
    celery = Celery(
        app.import_name,
        backend=app.config['CELERY_RESULT_BACKEND'],
        broker=app.config['CELERY_BROKER_URL']
    )
    
    class ContextTask(celery.Task):
        """ä¿æŒFlaskåº”ç”¨ä¸Šä¸‹æ–‡çš„ä»»åŠ¡åŸºç±»"""
        def __call__(self, *args, **kwargs):
            with app.app_context():
                return self.run(*args, **kwargs)
    
    celery.Task = ContextTask
    return celery

# ä»»åŠ¡å®šä¹‰
@celery.task
def send_async_email(to, subject, template, **kwargs):
    """å¼‚æ­¥å‘é€é‚®ä»¶"""
    from app.services.mail_service import send_email
    send_email(to, subject, template, **kwargs)

@celery.task
def process_image(image_path):
    """å¼‚æ­¥å¤„ç†å›¾ç‰‡"""
    from PIL import Image
    
    # ç”Ÿæˆç¼©ç•¥å›¾
    with Image.open(image_path) as img:
        img.thumbnail((200, 200))
        thumbnail_path = image_path.replace('.jpg', '_thumb.jpg')
        img.save(thumbnail_path)
    
    return thumbnail_path
```

### ğŸ”§ RQé›†æˆï¼ˆè½»é‡çº§é€‰æ‹©ï¼‰
app/tasks/rq_tasks.py
```python
from rq import Queue
from redis import Redis
from flask import current_app

# Redisè¿æ¥
redis_conn = Redis.from_url(current_app.config['REDIS_URL'])
queue = Queue(connection=redis_conn)

def enqueue_task(func, *args, **kwargs):
    """å°†ä»»åŠ¡åŠ å…¥é˜Ÿåˆ—"""
    job = queue.enqueue(func, *args, **kwargs)
    return job.id

# ä»»åŠ¡å‡½æ•°
def send_notification(user_id, message):
    """å‘é€é€šçŸ¥ä»»åŠ¡"""
    from app.models import User
    user = User.query.get(user_id)
    # å‘é€é€šçŸ¥é€»è¾‘
    pass
```

## ğŸš€ 9.6 ç¼“å­˜ç­–ç•¥ä¸å®ç°

### ğŸ¯ å¤šå±‚ç¼“å­˜æ¶æ„

```mermaid
graph TD
    A[ç”¨æˆ·è¯·æ±‚] --> B[åº”ç”¨å±‚ç¼“å­˜]
    B --> C{ç¼“å­˜å‘½ä¸­?}
    C -->|æ˜¯| D[è¿”å›ç¼“å­˜æ•°æ®]
    C -->|å¦| E[æ•°æ®åº“æŸ¥è¯¢ç¼“å­˜]
    E --> F{ç¼“å­˜å‘½ä¸­?}
    F -->|æ˜¯| G[è¿”å›æ•°æ®åº“ç¼“å­˜]
    F -->|å¦| H[æŸ¥è¯¢æ•°æ®åº“]
    H --> I[æ›´æ–°ç¼“å­˜]
    I --> J[è¿”å›æ•°æ®]
```

### ğŸ’¡ Flask-Cachingé›†æˆ
app/cache/__init__.py
```python
from flask_caching import Cache
from functools import wraps
import hashlib
import json

cache = Cache()

def cache_key(*args, **kwargs):
    """ç”Ÿæˆç¼“å­˜é”®"""
    key_data = {'args': args, 'kwargs': kwargs}
    key_string = json.dumps(key_data, sort_keys=True)
    return hashlib.md5(key_string.encode()).hexdigest()

def cached_result(timeout=300, key_prefix=''):
    """ç»“æœç¼“å­˜è£…é¥°å™¨"""
    def decorator(func):
        @wraps(func)
        def wrapper(*args, **kwargs):
            # ç”Ÿæˆç¼“å­˜é”®
            key = f"{key_prefix}:{func.__name__}:{cache_key(*args, **kwargs)}"
            
            # å°è¯•ä»ç¼“å­˜è·å–
            result = cache.get(key)
            if result is not None:
                return result
            
            # æ‰§è¡Œå‡½æ•°å¹¶ç¼“å­˜ç»“æœ
            result = func(*args, **kwargs)
            cache.set(key, result, timeout=timeout)
            return result
        return wrapper
    return decorator
```

### ğŸ”§ ç¼“å­˜ä½¿ç”¨ç¤ºä¾‹
app/services/blog_service.py
```python
from app.cache import cache, cached_result
from app.models import Post

class BlogService:
    """åšå®¢æœåŠ¡"""
    
    @cached_result(timeout=600, key_prefix='blog')
    def get_popular_posts(self, limit=10):
        """è·å–çƒ­é—¨æ–‡ç« ï¼ˆç¼“å­˜10åˆ†é’Ÿï¼‰"""
        return Post.query.filter_by(published=True)\
                        .order_by(Post.view_count.desc())\
                        .limit(limit).all()
    
    @cache.memoize(timeout=300)
    def get_post_by_slug(self, slug):
        """æ ¹æ®slugè·å–æ–‡ç« ï¼ˆç¼“å­˜5åˆ†é’Ÿï¼‰"""
        return Post.query.filter_by(slug=slug).first()
    
    def invalidate_post_cache(self, post_id):
        """ä½¿æ–‡ç« ç›¸å…³ç¼“å­˜å¤±æ•ˆ"""
        post = Post.query.get(post_id)
        if post:
            cache.delete_memoized(self.get_post_by_slug, post.slug)
            # æ¸…é™¤ç›¸å…³çš„åˆ—è¡¨ç¼“å­˜
            cache.delete_many('blog:get_popular_posts:*')
```

## âš™ï¸ 9.7 é…ç½®ç®¡ç†ä¸ç¯å¢ƒéš”ç¦»

### ğŸ¯ é…ç½®å±‚æ¬¡ç»“æ„

```mermaid
graph TD
    A[åŸºç¡€é…ç½®] --> B[å¼€å‘ç¯å¢ƒé…ç½®]
    A --> C[æµ‹è¯•ç¯å¢ƒé…ç½®]
    A --> D[ç”Ÿäº§ç¯å¢ƒé…ç½®]
    E[ç¯å¢ƒå˜é‡] --> B
    E --> C
    E --> D
    F[é…ç½®æ–‡ä»¶] --> B
    F --> C
    F --> D
```

### ğŸ’¡ é…ç½®ç±»è®¾è®¡
config.py
```python
import os
from datetime import timedelta

class Config:
    """åŸºç¡€é…ç½®ç±»"""
    
    # åŸºç¡€é…ç½®
    SECRET_KEY = os.environ.get('SECRET_KEY') or 'dev-secret-key'
    
    # æ•°æ®åº“é…ç½®
    SQLALCHEMY_TRACK_MODIFICATIONS = False
    SQLALCHEMY_RECORD_QUERIES = True
    
    # ç¼“å­˜é…ç½®
    CACHE_TYPE = 'redis'
    CACHE_REDIS_URL = os.environ.get('REDIS_URL') or 'redis://localhost:6379/0'
    
    # é‚®ä»¶é…ç½®
    MAIL_SERVER = os.environ.get('MAIL_SERVER')
    MAIL_PORT = int(os.environ.get('MAIL_PORT') or 587)
    MAIL_USE_TLS = os.environ.get('MAIL_USE_TLS', 'true').lower() in ['true', 'on', '1']
    
    # Celeryé…ç½®
    CELERY_BROKER_URL = os.environ.get('CELERY_BROKER_URL') or 'redis://localhost:6379/1'
    CELERY_RESULT_BACKEND = os.environ.get('CELERY_RESULT_BACKEND') or 'redis://localhost:6379/1'
    
    @staticmethod
    def init_app(app):
        """åˆå§‹åŒ–åº”ç”¨é…ç½®"""
        pass

class DevelopmentConfig(Config):
    """å¼€å‘ç¯å¢ƒé…ç½®"""
    DEBUG = True
    SQLALCHEMY_DATABASE_URI = os.environ.get('DEV_DATABASE_URL') or \
        'sqlite:///dev.db'
    
    # å¼€å‘ç¯å¢ƒç‰¹å®šé…ç½®
    WTF_CSRF_ENABLED = False  # å¼€å‘æ—¶ç¦ç”¨CSRF
    SEND_FILE_MAX_AGE_DEFAULT = 0  # ç¦ç”¨é™æ€æ–‡ä»¶ç¼“å­˜

class TestingConfig(Config):
    """æµ‹è¯•ç¯å¢ƒé…ç½®"""
    TESTING = True
    SQLALCHEMY_DATABASE_URI = 'sqlite:///:memory:'
    WTF_CSRF_ENABLED = False
    
class ProductionConfig(Config):
    """ç”Ÿäº§ç¯å¢ƒé…ç½®"""
    SQLALCHEMY_DATABASE_URI = os.environ.get('DATABASE_URL')
    
    # ç”Ÿäº§ç¯å¢ƒå®‰å…¨é…ç½®
    SESSION_COOKIE_SECURE = True
    SESSION_COOKIE_HTTPONLY = True
    SESSION_COOKIE_SAMESITE = 'Lax'
    PERMANENT_SESSION_LIFETIME = timedelta(hours=1)
    
    @classmethod
    def init_app(cls, app):
        Config.init_app(app)
        
        # ç”Ÿäº§ç¯å¢ƒæ—¥å¿—é…ç½®
        import logging
        from logging.handlers import RotatingFileHandler
        
        if not app.debug:
            file_handler = RotatingFileHandler(
                'logs/app.log', maxBytes=10240, backupCount=10
            )
            file_handler.setFormatter(logging.Formatter(
                '%(asctime)s %(levelname)s: %(message)s [in %(pathname)s:%(lineno)d]'
            ))
            file_handler.setLevel(logging.INFO)
            app.logger.addHandler(file_handler)

# é…ç½®æ˜ å°„
config = {
    'development': DevelopmentConfig,
    'testing': TestingConfig,
    'production': ProductionConfig,
    'default': DevelopmentConfig
}
```

### ğŸ”§ ç¯å¢ƒé…ç½®ç®¡ç†
app/config/manager.py
```python
import os
from typing import Any, Dict

class ConfigManager:
    """é…ç½®ç®¡ç†å™¨"""
    
    def __init__(self, app=None):
        self.app = app
        self._config_cache = {}
        
        if app is not None:
            self.init_app(app)
    
    def init_app(self, app):
        """åˆå§‹åŒ–é…ç½®ç®¡ç†å™¨"""
        app.config_manager = self
        
        # åŠ è½½ç¯å¢ƒç‰¹å®šé…ç½®
        self.load_env_config(app)
    
    def load_env_config(self, app):
        """åŠ è½½ç¯å¢ƒé…ç½®"""
        env = os.environ.get('FLASK_ENV', 'development')
        
        # åŠ è½½.envæ–‡ä»¶
        env_file = f'.env.{env}'
        if os.path.exists(env_file):
            self.load_dotenv(env_file)
    
    def load_dotenv(self, filepath):
        """åŠ è½½.envæ–‡ä»¶"""
        with open(filepath, 'r') as f:
            for line in f:
                if line.strip() and not line.startswith('#'):
                    key, value = line.strip().split('=', 1)
                    os.environ.setdefault(key, value)
    
    def get(self, key: str, default: Any = None) -> Any:
        """è·å–é…ç½®å€¼"""
        if key in self._config_cache:
            return self._config_cache[key]
        
        value = self.app.config.get(key, default)
        self._config_cache[key] = value
        return value
    
    def set(self, key: str, value: Any):
        """è®¾ç½®é…ç½®å€¼"""
        self.app.config[key] = value
        self._config_cache[key] = value
```

## ğŸ“š æœ¬ç« å°ç»“

é€šè¿‡æœ¬ç« çš„å­¦ä¹ ï¼Œæˆ‘ä»¬æŒæ¡äº†Flaskåº”ç”¨æ¶æ„è®¾è®¡çš„æ ¸å¿ƒæŠ€æœ¯ï¼š

- **ğŸ”µ è“å›¾ç³»ç»Ÿ**ï¼šå®ç°åº”ç”¨æ¨¡å—åŒ–ï¼Œæ”¯æŒå¤§å‹é¡¹ç›®å¼€å‘
- **ğŸ”µ åº”ç”¨å·¥å‚**ï¼šæä¾›çµæ´»çš„åº”ç”¨åˆ›å»ºå’Œé…ç½®æœºåˆ¶
- **ğŸ”µ æ’ä»¶ç³»ç»Ÿ**ï¼šæ”¯æŒåŠŸèƒ½çš„åŠ¨æ€æ‰©å±•å’Œç®¡ç†
- **ğŸ”µ äº‹ä»¶é©±åŠ¨**ï¼šå®ç°ç»„ä»¶é—´æ¾è€¦åˆé€šä¿¡
- **ğŸ”µ æ¶ˆæ¯é˜Ÿåˆ—**ï¼šå¤„ç†å¼‚æ­¥ä»»åŠ¡ï¼Œæå‡åº”ç”¨æ€§èƒ½
- **ğŸ”µ ç¼“å­˜ç­–ç•¥**ï¼šå¤šå±‚ç¼“å­˜æå‡å“åº”é€Ÿåº¦
- **ğŸ”µ é…ç½®ç®¡ç†**ï¼šç¯å¢ƒéš”ç¦»å’Œé…ç½®çš„ç»Ÿä¸€ç®¡ç†

è¿™äº›æ¶æ„æ¨¡å¼å’ŒæŠ€æœ¯çš„åˆç†è¿ç”¨ï¼Œå°†å¸®åŠ©ä½ æ„å»ºå‡ºå¯ç»´æŠ¤ã€å¯æ‰©å±•ã€é«˜æ€§èƒ½çš„Flaskåº”ç”¨ã€‚åœ¨ä¸‹ä¸€ç« ä¸­ï¼Œæˆ‘ä»¬å°†å­¦ä¹ é”™è¯¯å¤„ç†ä¸ç›‘æ§ï¼Œç¡®ä¿åº”ç”¨çš„ç¨³å®šæ€§å’Œå¯è§‚æµ‹æ€§ã€‚
        