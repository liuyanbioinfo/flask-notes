# âš¡ 3. Flask æ ¸å¿ƒæ¦‚å¿µ

## ğŸ”Œ 3.1 WSGI åè®®ä¸åº”ç”¨ç”Ÿå‘½å‘¨æœŸ


### WSGI åè®®æ·±å…¥ç†è§£

WSGIï¼ˆWeb Server Gateway Interfaceï¼‰æ˜¯ Python Web åº”ç”¨ä¸ Web æœåŠ¡å™¨ä¹‹é—´çš„æ ‡å‡†æ¥å£ã€‚Flask ä½œä¸º WSGI åº”ç”¨ï¼Œéœ€è¦æ·±å…¥ç†è§£è¿™ä¸ªåè®®æ‰èƒ½æ›´å¥½åœ°æŒæ¡å…¶å·¥ä½œåŸç†ã€‚

```mermaid
sequenceDiagram
    participant Client as å®¢æˆ·ç«¯
    participant WebServer as WebæœåŠ¡å™¨
    participant WSGIApp as WSGIåº”ç”¨
    participant Flask as Flaskåº”ç”¨
    
    Client->>WebServer: HTTPè¯·æ±‚
    WebServer->>WSGIApp: è°ƒç”¨WSGIåº”ç”¨
    WSGIApp->>Flask: ä¼ é€’environå’Œstart_response
    Flask->>Flask: å¤„ç†è¯·æ±‚é€»è¾‘
    Flask->>WSGIApp: è¿”å›å“åº”è¿­ä»£å™¨
    WSGIApp->>WebServer: è¿”å›å“åº”æ•°æ®
    WebServer->>Client: HTTPå“åº”
```

### WSGI åº”ç”¨ç»“æ„

```python
# æœ€ç®€å•çš„ WSGI åº”ç”¨
def simple_wsgi_app(environ, start_response):
    """æœ€åŸºç¡€çš„ WSGI åº”ç”¨ç¤ºä¾‹"""
    status = '200 OK'
    headers = [('Content-Type', 'text/plain; charset=utf-8')]
    start_response(status, headers)
    return [b'Hello, WSGI World!']

# Flask åº”ç”¨çš„ WSGI æ¥å£
from flask import Flask

app = Flask(__name__)

@app.route('/')
def hello():
    return 'Hello, Flask!'

# Flask åº”ç”¨æœ¬èº«å°±æ˜¯ä¸€ä¸ª WSGI åº”ç”¨
# app.__call__ æ–¹æ³•å®ç°äº† WSGI æ¥å£
if __name__ == '__main__':
    from wsgiref.simple_server import make_server
    server = make_server('localhost', 8000, app)
    server.serve_forever()
```

### Flask åº”ç”¨ç”Ÿå‘½å‘¨æœŸ

```mermaid
flowchart TD
    A[åº”ç”¨å¯åŠ¨] --> B[åŠ è½½é…ç½®]
    B --> C[æ³¨å†Œè“å›¾]
    C --> D[åˆå§‹åŒ–æ‰©å±•]
    D --> E[åº”ç”¨å°±ç»ª]
    
    E --> F[æ¥æ”¶è¯·æ±‚]
    F --> G[åˆ›å»ºè¯·æ±‚ä¸Šä¸‹æ–‡]
    G --> H[URLè·¯ç”±åŒ¹é…]
    H --> I[æ‰§è¡Œè§†å›¾å‡½æ•°]
    I --> J[ç”Ÿæˆå“åº”]
    J --> K[æ¸…ç†ä¸Šä¸‹æ–‡]
    K --> L[è¿”å›å“åº”]
    
    L --> F
    
    style A fill:#ffcdd2
    style E fill:#c8e6c9
    style F fill:#e1f5fe
    style L fill:#fff3e0
```

### åº”ç”¨ç”Ÿå‘½å‘¨æœŸé’©å­

```python
from flask import Flask, g, request
import time

app = Flask(__name__)

# åº”ç”¨å¯åŠ¨å‰
@app.before_first_request
def before_first_request():
    """åœ¨å¤„ç†ç¬¬ä¸€ä¸ªè¯·æ±‚å‰æ‰§è¡Œ"""
    print("åº”ç”¨é¦–æ¬¡å¯åŠ¨ï¼Œæ‰§è¡Œåˆå§‹åŒ–æ“ä½œ")
    # å¯ä»¥åœ¨è¿™é‡Œè¿›è¡Œæ•°æ®åº“è¿æ¥ã€ç¼“å­˜é¢„çƒ­ç­‰æ“ä½œ

# æ¯ä¸ªè¯·æ±‚å‰
@app.before_request
def before_request():
    """åœ¨æ¯ä¸ªè¯·æ±‚å¤„ç†å‰æ‰§è¡Œ"""
    g.start_time = time.time()
    g.user_id = request.headers.get('X-User-ID')
    print(f"è¯·æ±‚å¼€å§‹: {request.method} {request.path}")

# æ¯ä¸ªè¯·æ±‚å
@app.after_request
def after_request(response):
    """åœ¨æ¯ä¸ªè¯·æ±‚å¤„ç†åæ‰§è¡Œ"""
    duration = time.time() - g.start_time
    print(f"è¯·æ±‚å®Œæˆï¼Œè€—æ—¶: {duration:.3f}s")
    response.headers['X-Response-Time'] = str(duration)
    return response

# è¯·æ±‚ç»“æŸæ—¶ï¼ˆæ— è®ºæ˜¯å¦æœ‰å¼‚å¸¸ï¼‰
@app.teardown_request
def teardown_request(exception):
    """è¯·æ±‚ç»“æŸæ—¶æ‰§è¡Œæ¸…ç†å·¥ä½œ"""
    if exception:
        print(f"è¯·æ±‚å¼‚å¸¸: {exception}")
    # æ¸…ç†èµ„æºï¼Œå¦‚æ•°æ®åº“è¿æ¥ç­‰

# åº”ç”¨ä¸Šä¸‹æ–‡ç»“æŸæ—¶
@app.teardown_appcontext
def teardown_appcontext(exception):
    """åº”ç”¨ä¸Šä¸‹æ–‡ç»“æŸæ—¶æ‰§è¡Œ"""
    # æ¸…ç†åº”ç”¨çº§åˆ«çš„èµ„æº
    pass
```

## ğŸ­ 3.2 åº”ç”¨å·¥å‚æ¨¡å¼ï¼ˆApplication Factoryï¼‰

### ä¼ ç»Ÿåº”ç”¨ç»“æ„çš„é—®é¢˜

```python
# ä¼ ç»Ÿæ–¹å¼ - å­˜åœ¨é—®é¢˜
from flask import Flask
from flask_sqlalchemy import SQLAlchemy

# å…¨å±€å˜é‡ï¼Œéš¾ä»¥æµ‹è¯•å’Œé…ç½®
app = Flask(__name__)
app.config['SQLALCHEMY_DATABASE_URI'] = 'sqlite:///app.db'
db = SQLAlchemy(app)

@app.route('/')
def index():
    return 'Hello World'

# é—®é¢˜ï¼š
# 1. éš¾ä»¥è¿›è¡Œå•å…ƒæµ‹è¯•
# 2. æ— æ³•åŠ¨æ€é…ç½®
# 3. å¾ªç¯å¯¼å…¥é—®é¢˜
# 4. æ‰©å±•åˆå§‹åŒ–æ—¶æœºå›ºå®š
```

### åº”ç”¨å·¥å‚æ¨¡å¼å®ç°

```python
# app/__init__.py - åº”ç”¨å·¥å‚
from flask import Flask
from flask_sqlalchemy import SQLAlchemy
from flask_login import LoginManager
from flask_migrate import Migrate

# åˆ›å»ºæ‰©å±•å®ä¾‹ï¼ˆä½†ä¸åˆå§‹åŒ–ï¼‰
db = SQLAlchemy()
login_manager = LoginManager()
migrate = Migrate()

def create_app(config_name='development'):
    """åº”ç”¨å·¥å‚å‡½æ•°"""
    app = Flask(__name__)
    
    # åŠ è½½é…ç½®
    app.config.from_object(f'config.{config_name.title()}Config')
    
    # åˆå§‹åŒ–æ‰©å±•
    db.init_app(app)
    login_manager.init_app(app)
    migrate.init_app(app, db)
    
    # é…ç½®ç™»å½•ç®¡ç†å™¨
    login_manager.login_view = 'auth.login'
    login_manager.login_message = 'è¯·å…ˆç™»å½•è®¿é—®æ­¤é¡µé¢'
    
    # æ³¨å†Œè“å›¾
    from app.main import bp as main_bp
    app.register_blueprint(main_bp)
    
    from app.auth import bp as auth_bp
    app.register_blueprint(auth_bp, url_prefix='/auth')
    
    from app.api import bp as api_bp
    app.register_blueprint(api_bp, url_prefix='/api')
    
    # æ³¨å†Œé”™è¯¯å¤„ç†å™¨
    register_error_handlers(app)
    
    # æ³¨å†ŒCLIå‘½ä»¤
    register_cli_commands(app)
    
    return app

def register_error_handlers(app):
    """æ³¨å†Œé”™è¯¯å¤„ç†å™¨"""
    @app.errorhandler(404)
    def not_found_error(error):
        return render_template('errors/404.html'), 404
    
    @app.errorhandler(500)
    def internal_error(error):
        db.session.rollback()
        return render_template('errors/500.html'), 500

def register_cli_commands(app):
    """æ³¨å†ŒCLIå‘½ä»¤"""
    @app.cli.command()
    def init_db():
        """åˆå§‹åŒ–æ•°æ®åº“"""
        db.create_all()
        print('æ•°æ®åº“åˆå§‹åŒ–å®Œæˆ')
```

### é…ç½®ç®¡ç†

```python
# config.py - é…ç½®ç®¡ç†
import os
from datetime import timedelta

class Config:
    """åŸºç¡€é…ç½®ç±»"""
    SECRET_KEY = os.environ.get('SECRET_KEY') or 'dev-secret-key'
    SQLALCHEMY_TRACK_MODIFICATIONS = False
    PERMANENT_SESSION_LIFETIME = timedelta(days=7)
    
    # é‚®ä»¶é…ç½®
    MAIL_SERVER = os.environ.get('MAIL_SERVER')
    MAIL_PORT = int(os.environ.get('MAIL_PORT') or 587)
    MAIL_USE_TLS = os.environ.get('MAIL_USE_TLS', 'true').lower() in ['true', 'on', '1']
    MAIL_USERNAME = os.environ.get('MAIL_USERNAME')
    MAIL_PASSWORD = os.environ.get('MAIL_PASSWORD')
    
    # åˆ†é¡µé…ç½®
    POSTS_PER_PAGE = 10
    USERS_PER_PAGE = 20
    
    @staticmethod
    def init_app(app):
        """åº”ç”¨ç‰¹å®šçš„åˆå§‹åŒ–"""
        pass

class DevelopmentConfig(Config):
    """å¼€å‘ç¯å¢ƒé…ç½®"""
    DEBUG = True
    SQLALCHEMY_DATABASE_URI = os.environ.get('DEV_DATABASE_URL') or \
        'sqlite:///' + os.path.join(os.path.dirname(__file__), 'data-dev.sqlite')
    
    # å¼€å‘ç¯å¢ƒç‰¹å®šé…ç½®
    SQLALCHEMY_ECHO = True  # æ˜¾ç¤ºSQLæŸ¥è¯¢
    WTF_CSRF_TIME_LIMIT = None  # ç¦ç”¨CSRFè¶…æ—¶

class TestingConfig(Config):
    """æµ‹è¯•ç¯å¢ƒé…ç½®"""
    TESTING = True
    SQLALCHEMY_DATABASE_URI = 'sqlite:///:memory:'
    WTF_CSRF_ENABLED = False
    
class ProductionConfig(Config):
    """ç”Ÿäº§ç¯å¢ƒé…ç½®"""
    SQLALCHEMY_DATABASE_URI = os.environ.get('DATABASE_URL') or \
        'sqlite:///' + os.path.join(os.path.dirname(__file__), 'data.sqlite')
    
    @classmethod
    def init_app(cls, app):
        Config.init_app(app)
        
        # ç”Ÿäº§ç¯å¢ƒç‰¹å®šåˆå§‹åŒ–
        import logging
        from logging.handlers import RotatingFileHandler
        
        if not app.debug:
            if not os.path.exists('logs'):
                os.mkdir('logs')
            file_handler = RotatingFileHandler('logs/app.log', maxBytes=10240, backupCount=10)
            file_handler.setFormatter(logging.Formatter(
                '%(asctime)s %(levelname)s: %(message)s [in %(pathname)s:%(lineno)d]'))
            file_handler.setLevel(logging.INFO)
            app.logger.addHandler(file_handler)
            app.logger.setLevel(logging.INFO)
            app.logger.info('åº”ç”¨å¯åŠ¨')

# é…ç½®å­—å…¸
config = {
    'development': DevelopmentConfig,
    'testing': TestingConfig,
    'production': ProductionConfig,
    'default': DevelopmentConfig
}
```

### åº”ç”¨å¯åŠ¨æ–‡ä»¶

```python
# run.py - åº”ç”¨å¯åŠ¨
import os
from app import create_app, db
from app.models import User, Post

# ä»ç¯å¢ƒå˜é‡è·å–é…ç½®ï¼Œé»˜è®¤ä¸ºå¼€å‘ç¯å¢ƒ
app = create_app(os.getenv('FLASK_CONFIG') or 'development')

@app.shell_context_processor
def make_shell_context():
    """ä¸º flask shell å‘½ä»¤æä¾›ä¸Šä¸‹æ–‡"""
    return {'db': db, 'User': User, 'Post': Post}

if __name__ == '__main__':
    app.run(debug=True)
```

## ğŸ›£ï¸ 3.3 è·¯ç”±ç³»ç»Ÿæ·±å…¥è§£æ

### è·¯ç”±æ³¨å†Œæœºåˆ¶

```mermaid
flowchart TD
    A[å®šä¹‰è·¯ç”±] --> B[è£…é¥°å™¨å¤„ç†]
    B --> C[æ·»åŠ åˆ°URLæ˜ å°„]
    C --> D[æ„å»ºè·¯ç”±è§„åˆ™]
    D --> E[ç¼–è¯‘æ­£åˆ™è¡¨è¾¾å¼]
    E --> F[å­˜å‚¨åˆ°è·¯ç”±è¡¨]
    
    G[è¯·æ±‚åˆ°è¾¾] --> H[URLåŒ¹é…]
    H --> I[æå–å‚æ•°]
    I --> J[è°ƒç”¨è§†å›¾å‡½æ•°]
    
    style A fill:#e1f5fe
    style G fill:#c8e6c9
```

### è·¯ç”±è£…é¥°å™¨æ·±å…¥

```python
from flask import Flask, request, url_for
from functools import wraps

app = Flask(__name__)

# åŸºç¡€è·¯ç”±
@app.route('/')
def index():
    return 'Hello World'

# å¤šç§HTTPæ–¹æ³•
@app.route('/api/users', methods=['GET', 'POST'])
def users():
    if request.method == 'GET':
        return {'users': []}
    elif request.method == 'POST':
        return {'message': 'User created'}, 201

# åŠ¨æ€è·¯ç”±å‚æ•°
@app.route('/user/<int:user_id>')
def show_user(user_id):
    return f'User ID: {user_id}'

@app.route('/post/<slug>')
def show_post(slug):
    return f'Post: {slug}'

# å¯é€‰å‚æ•°
@app.route('/page/')
@app.route('/page/<int:page>')
def show_page(page=1):
    return f'Page: {page}'

# è·¯å¾„å‚æ•°ï¼ˆåŒ…å«æ–œæ ï¼‰
@app.route('/path/<path:subpath>')
def show_subpath(subpath):
    return f'Subpath: {subpath}'

# UUIDå‚æ•°
@app.route('/object/<uuid:object_id>')
def show_object(object_id):
    return f'Object ID: {object_id}'
```

### è‡ªå®šä¹‰è·¯ç”±è½¬æ¢å™¨

```python
from werkzeug.routing import BaseConverter

class ListConverter(BaseConverter):
    """è‡ªå®šä¹‰åˆ—è¡¨è½¬æ¢å™¨"""
    def to_python(self, value):
        return value.split(',')
    
    def to_url(self, values):
        return ','.join(BaseConverter.to_url(value) for value in values)

class RegexConverter(BaseConverter):
    """æ­£åˆ™è¡¨è¾¾å¼è½¬æ¢å™¨"""
    def __init__(self, url_map, *items):
        super(RegexConverter, self).__init__(url_map)
        self.regex = items[0]

# æ³¨å†Œè‡ªå®šä¹‰è½¬æ¢å™¨
app.url_map.converters['list'] = ListConverter
app.url_map.converters['regex'] = RegexConverter

# ä½¿ç”¨è‡ªå®šä¹‰è½¬æ¢å™¨
@app.route('/tags/<list:tags>')
def show_tags(tags):
    return f'Tags: {tags}'

@app.route('/user/<regex("[a-z]+"):username>')
def show_user_regex(username):
    return f'Username: {username}'
```

### è·¯ç”±ç»„ç»‡ä¸è“å›¾

```python
# app/main/routes.py - ä¸»è¦è·¯ç”±
from flask import Blueprint, render_template, request, current_app
from app.models import Post

bp = Blueprint('main', __name__)

@bp.route('/')
@bp.route('/index')
def index():
    page = request.args.get('page', 1, type=int)
    posts = Post.query.paginate(
        page=page,
        per_page=current_app.config['POSTS_PER_PAGE'],
        error_out=False
    )
    return render_template('index.html', posts=posts)

@bp.route('/about')
def about():
    return render_template('about.html')

# app/auth/routes.py - è®¤è¯è·¯ç”±
from flask import Blueprint, render_template, redirect, url_for, flash
from flask_login import login_user, logout_user, current_user
from app.auth.forms import LoginForm, RegistrationForm
from app.models import User
from app import db

bp = Blueprint('auth', __name__)

@bp.route('/login', methods=['GET', 'POST'])
def login():
    if current_user.is_authenticated:
        return redirect(url_for('main.index'))
    
    form = LoginForm()
    if form.validate_on_submit():
        user = User.query.filter_by(username=form.username.data).first()
        if user and user.check_password(form.password.data):
            login_user(user, remember=form.remember_me.data)
            return redirect(url_for('main.index'))
        flash('ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯')
    
    return render_template('auth/login.html', form=form)

@bp.route('/logout')
def logout():
    logout_user()
    return redirect(url_for('main.index'))
```

## ğŸ”„ 3.4 è¯·æ±‚å’Œå“åº”å¤„ç†

### è¯·æ±‚å¯¹è±¡è¯¦è§£

```python
from flask import Flask, request, jsonify
import json

app = Flask(__name__)

@app.route('/request-info', methods=['GET', 'POST', 'PUT', 'DELETE'])
def request_info():
    """å±•ç¤ºè¯·æ±‚å¯¹è±¡çš„å„ç§å±æ€§"""
    info = {
        # åŸºæœ¬ä¿¡æ¯
        'method': request.method,
        'url': request.url,
        'base_url': request.base_url,
        'url_root': request.url_root,
        'path': request.path,
        'query_string': request.query_string.decode(),
        
        # è¯·æ±‚å¤´
        'headers': dict(request.headers),
        'user_agent': str(request.user_agent),
        'remote_addr': request.remote_addr,
        
        # å‚æ•°
        'args': dict(request.args),  # GETå‚æ•°
        'form': dict(request.form),  # POSTè¡¨å•æ•°æ®
        'files': list(request.files.keys()),  # ä¸Šä¼ æ–‡ä»¶
        
        # JSONæ•°æ®
        'is_json': request.is_json,
        'json': request.get_json() if request.is_json else None,
        
        # å…¶ä»–
        'cookies': dict(request.cookies),
        'endpoint': request.endpoint,
        'view_args': request.view_args,
    }
    
    return jsonify(info)

# å¤„ç†ä¸åŒç±»å‹çš„è¯·æ±‚æ•°æ®
@app.route('/data', methods=['POST'])
def handle_data():
    """å¤„ç†ä¸åŒæ ¼å¼çš„è¯·æ±‚æ•°æ®"""
    
    # JSONæ•°æ®
    if request.is_json:
        data = request.get_json()
        return jsonify({'received': data, 'type': 'json'})
    
    # è¡¨å•æ•°æ®
    elif request.form:
        data = dict(request.form)
        return jsonify({'received': data, 'type': 'form'})
    
    # åŸå§‹æ•°æ®
    elif request.data:
        data = request.data.decode('utf-8')
        return jsonify({'received': data, 'type': 'raw'})
    
    else:
        return jsonify({'error': 'No data received'}), 400
```

### å“åº”å¯¹è±¡æ„å»º

```python
from flask import Flask, make_response, jsonify, render_template, redirect, url_for
from datetime import datetime, timedelta

app = Flask(__name__)

# ç®€å•å­—ç¬¦ä¸²å“åº”
@app.route('/simple')
def simple_response():
    return 'Hello World'

# å¸¦çŠ¶æ€ç çš„å“åº”
@app.route('/with-status')
def response_with_status():
    return 'Created', 201

# å¸¦å¤´éƒ¨çš„å“åº”
@app.route('/with-headers')
def response_with_headers():
    return 'Hello', 200, {'X-Custom-Header': 'Custom Value'}

# ä½¿ç”¨ make_response æ„å»ºå¤æ‚å“åº”
@app.route('/complex')
def complex_response():
    resp = make_response('Complex Response')
    resp.status_code = 200
    resp.headers['X-Custom'] = 'Value'
    resp.headers['Cache-Control'] = 'no-cache'
    
    # è®¾ç½®Cookie
    resp.set_cookie('session_id', 'abc123', 
                   expires=datetime.now() + timedelta(days=30),
                   secure=True, httponly=True)
    
    return resp

# JSONå“åº”
@app.route('/json')
def json_response():
    data = {
        'message': 'Success',
        'timestamp': datetime.now().isoformat(),
        'data': [1, 2, 3, 4, 5]
    }
    return jsonify(data)

# æ–‡ä»¶ä¸‹è½½å“åº”
@app.route('/download')
def download_file():
    from flask import send_file
    return send_file('static/files/document.pdf', 
                    as_attachment=True, 
                    download_name='my_document.pdf')

# é‡å®šå‘å“åº”
@app.route('/redirect-example')
def redirect_example():
    return redirect(url_for('simple_response'))

# æµå¼å“åº”
@app.route('/stream')
def stream_response():
    def generate():
        for i in range(1000):
            yield f'data chunk {i}\n'
    
    return app.response_class(generate(), mimetype='text/plain')
```

### å“åº”å¤„ç†ä¸­é—´ä»¶

```python
@app.after_request
def after_request(response):
    """å“åº”åå¤„ç†ä¸­é—´ä»¶"""
    # æ·»åŠ å®‰å…¨å¤´
    response.headers['X-Content-Type-Options'] = 'nosniff'
    response.headers['X-Frame-Options'] = 'DENY'
    response.headers['X-XSS-Protection'] = '1; mode=block'
    
    # CORSå¤„ç†
    if request.method == 'OPTIONS':
        response.headers['Access-Control-Allow-Origin'] = '*'
        response.headers['Access-Control-Allow-Methods'] = 'GET, POST, PUT, DELETE'
        response.headers['Access-Control-Allow-Headers'] = 'Content-Type, Authorization'
    
    # æ€§èƒ½ç›‘æ§
    if hasattr(g, 'start_time'):
        response.headers['X-Response-Time'] = str(time.time() - g.start_time)
    
    return response
```

## ğŸ”— 3.5 ä¸­é—´ä»¶ä¸é’©å­å‡½æ•°

### è¯·æ±‚å¤„ç†æµç¨‹

```mermaid
sequenceDiagram
    participant Client as å®¢æˆ·ç«¯
    participant Flask as Flaskåº”ç”¨
    participant Middleware as ä¸­é—´ä»¶
    participant View as è§†å›¾å‡½æ•°
    
    Client->>Flask: HTTPè¯·æ±‚
    Flask->>Middleware: before_request
    Middleware->>Flask: ç»§ç»­å¤„ç†
    Flask->>View: è°ƒç”¨è§†å›¾å‡½æ•°
    View->>Flask: è¿”å›å“åº”
    Flask->>Middleware: after_request
    Middleware->>Flask: å¤„ç†åçš„å“åº”
    Flask->>Client: HTTPå“åº”
```

### ä¸­é—´ä»¶å®ç°æ¨¡å¼

```python
from flask import Flask, request, g, session
from functools import wraps
import time
import logging

app = Flask(__name__)
app.secret_key = 'your-secret-key'

# æ€§èƒ½ç›‘æ§ä¸­é—´ä»¶
class PerformanceMiddleware:
    def __init__(self, app):
        self.app = app
        self.init_app(app)
    
    def init_app(self, app):
        app.before_request(self.before_request)
        app.after_request(self.after_request)
    
    def before_request(self):
        g.start_time = time.time()
    
    def after_request(self, response):
        duration = time.time() - g.start_time
        if duration > 1.0:  # è®°å½•æ…¢è¯·æ±‚
            app.logger.warning(f'Slow request: {request.path} took {duration:.3f}s')
        response.headers['X-Response-Time'] = f'{duration:.3f}'
        return response

# è®¤è¯ä¸­é—´ä»¶
class AuthMiddleware:
    def __init__(self, app):
        self.app = app
        self.init_app(app)
    
    def init_app(self, app):
        app.before_request(self.load_user)
    
    def load_user(self):
        user_id = session.get('user_id')
        if user_id:
            # ä»æ•°æ®åº“åŠ è½½ç”¨æˆ·ä¿¡æ¯
            g.current_user = User.query.get(user_id)
        else:
            g.current_user = None

# æ³¨å†Œä¸­é—´ä»¶
performance = PerformanceMiddleware(app)
auth = AuthMiddleware(app)
```

### è£…é¥°å™¨å½¢å¼çš„ä¸­é—´ä»¶

```python
def require_auth(f):
    """è®¤è¯è£…é¥°å™¨"""
    @wraps(f)
    def decorated_function(*args, **kwargs):
        if not g.current_user:
            return jsonify({'error': 'Authentication required'}), 401
        return f(*args, **kwargs)
    return decorated_function

def require_role(role):
    """è§’è‰²æƒé™è£…é¥°å™¨"""
    def decorator(f):
        @wraps(f)
        def decorated_function(*args, **kwargs):
            if not g.current_user or g.current_user.role != role:
                return jsonify({'error': 'Insufficient permissions'}), 403
            return f(*args, **kwargs)
        return decorated_function
    return decorator

def rate_limit(max_requests=100, window=3600):
    """é™æµè£…é¥°å™¨"""
    def decorator(f):
        @wraps(f)
        def decorated_function(*args, **kwargs):
            # å®ç°é™æµé€»è¾‘
            client_ip = request.remote_addr
            # æ£€æŸ¥è¯·æ±‚é¢‘ç‡...
            return f(*args, **kwargs)
        return decorated_function
    return decorator

# ä½¿ç”¨è£…é¥°å™¨
@app.route('/admin/users')
@require_auth
@require_role('admin')
@rate_limit(max_requests=50, window=3600)
def admin_users():
    return jsonify({'users': []})
```

## âš™ï¸ 3.6 é…ç½®ç®¡ç†ä¸ç¯å¢ƒå˜é‡

### é…ç½®å±‚æ¬¡ç»“æ„

```mermaid
flowchart TD
    A[é»˜è®¤é…ç½®] --> B[ç¯å¢ƒé…ç½®]
    B --> C[å®ä¾‹é…ç½®]
    C --> D[ç¯å¢ƒå˜é‡]
    D --> E[å‘½ä»¤è¡Œå‚æ•°]
    
    style A fill:#ffcdd2
    style E fill:#c8e6c9
```

### é«˜çº§é…ç½®ç®¡ç†

```python
# config.py - é«˜çº§é…ç½®ç®¡ç†
import os
from datetime import timedelta
from typing import Type

class Config:
    """åŸºç¡€é…ç½®ç±»"""
    # åŸºç¡€é…ç½®
    SECRET_KEY = os.environ.get('SECRET_KEY') or 'dev-secret-key'
    
    # æ•°æ®åº“é…ç½®
    SQLALCHEMY_TRACK_MODIFICATIONS = False
    SQLALCHEMY_RECORD_QUERIES = True
    SQLALCHEMY_ENGINE_OPTIONS = {
        'pool_pre_ping': True,
        'pool_recycle': 300,
    }
    
    # ä¼šè¯é…ç½®
    PERMANENT_SESSION_LIFETIME = timedelta(days=7)
    SESSION_COOKIE_SECURE = True
    SESSION_COOKIE_HTTPONLY = True
    SESSION_COOKIE_SAMESITE = 'Lax'
    
    # å®‰å…¨é…ç½®
    WTF_CSRF_TIME_LIMIT = 3600
    BCRYPT_LOG_ROUNDS = 12
    
    # é‚®ä»¶é…ç½®
    MAIL_SERVER = os.environ.get('MAIL_SERVER')
    MAIL_PORT = int(os.environ.get('MAIL_PORT') or 587)
    MAIL_USE_TLS = os.environ.get('MAIL_USE_TLS', 'true').lower() in ['true', 'on', '1']
    MAIL_USERNAME = os.environ.get('MAIL_USERNAME')
    MAIL_PASSWORD = os.environ.get('MAIL_PASSWORD')
    MAIL_SUBJECT_PREFIX = '[MyApp] '
    MAIL_SENDER = 'MyApp Admin <admin@myapp.com>'
    
    # Redisé…ç½®
    REDIS_URL = os.environ.get('REDIS_URL') or 'redis://localhost:6379/0'
    
    # ç¼“å­˜é…ç½®
    CACHE_TYPE = 'redis'
    CACHE_REDIS_URL = REDIS_URL
    CACHE_DEFAULT_TIMEOUT = 300
    
    # æ–‡ä»¶ä¸Šä¼ é…ç½®
    MAX_CONTENT_LENGTH = 16 * 1024 * 1024  # 16MB
    UPLOAD_FOLDER = os.path.join(os.path.dirname(__file__), 'uploads')
    ALLOWED_EXTENSIONS = {'txt', 'pdf', 'png', 'jpg', 'jpeg', 'gif'}
    
    # APIé…ç½®
    API_TITLE = 'My API'
    API_VERSION = 'v1'
    OPENAPI_VERSION = '3.0.2'
    
    # åˆ†é¡µé…ç½®
    POSTS_PER_PAGE = 10
    USERS_PER_PAGE = 20
    COMMENTS_PER_PAGE = 50
    
    @staticmethod
    def init_app(app):
        """åº”ç”¨ç‰¹å®šçš„åˆå§‹åŒ–"""
        pass
    
    @classmethod
    def get_config(cls) -> dict:
        """è·å–æ‰€æœ‰é…ç½®é¡¹"""
        return {key: getattr(cls, key) for key in dir(cls) 
                if not key.startswith('_') and key.isupper()}

class DevelopmentConfig(Config):
    """å¼€å‘ç¯å¢ƒé…ç½®"""
    DEBUG = True
    SQLALCHEMY_DATABASE_URI = os.environ.get('DEV_DATABASE_URL') or \
        'sqlite:///' + os.path.join(os.path.dirname(__file__), 'data-dev.sqlite')
    
    # å¼€å‘ç¯å¢ƒç‰¹å®šé…ç½®
    SQLALCHEMY_ECHO = True
    WTF_CSRF_ENABLED = False  # å¼€å‘æ—¶ç¦ç”¨CSRF
    SESSION_COOKIE_SECURE = False  # HTTPç¯å¢ƒ
    
    # é‚®ä»¶é…ç½®ï¼ˆå¼€å‘ç¯å¢ƒä½¿ç”¨æ§åˆ¶å°è¾“å‡ºï¼‰
    MAIL_SUPPRESS_SEND = True
    
    @classmethod
    def init_app(cls, app):
        Config.init_app(app)
        
        # å¼€å‘ç¯å¢ƒæ—¥å¿—é…ç½®
        import logging
        logging.basicConfig(level=logging.DEBUG)

class TestingConfig(Config):
    """æµ‹è¯•ç¯å¢ƒé…ç½®"""
    TESTING = True
    SQLALCHEMY_DATABASE_URI = 'sqlite:///:memory:'
    WTF_CSRF_ENABLED = False
    SESSION_COOKIE_SECURE = False
    
    # æµ‹è¯•ç¯å¢ƒç‰¹å®šé…ç½®
    BCRYPT_LOG_ROUNDS = 4  # åŠ å¿«æµ‹è¯•é€Ÿåº¦
    MAIL_SUPPRESS_SEND = True
    
class ProductionConfig(Config):
    """ç”Ÿäº§ç¯å¢ƒé…ç½®"""
    SQLALCHEMY_DATABASE_URI = os.environ.get('DATABASE_URL') or \
        'sqlite:///' + os.path.join(os.path.dirname(__file__), 'data.sqlite')
    
    @classmethod
    def init_app(cls, app):
        Config.init_app(app)
        
        # ç”Ÿäº§ç¯å¢ƒæ—¥å¿—é…ç½®
        import logging
        from logging.handlers import RotatingFileHandler, SMTPHandler
        
        # æ–‡ä»¶æ—¥å¿—
        if not os.path.exists('logs'):
            os.mkdir('logs')
        file_handler = RotatingFileHandler(
            'logs/app.log', maxBytes=10240000, backupCount=10)
        file_handler.setFormatter(logging.Formatter(
            '%(asctime)s %(levelname)s: %(message)s [in %(pathname)s:%(lineno)d]'))
        file_handler.setLevel(logging.INFO)
        app.logger.addHandler(file_handler)
        
        # é‚®ä»¶æ—¥å¿—ï¼ˆé”™è¯¯é€šçŸ¥ï¼‰
        if cls.MAIL_SERVER:
            auth = None
            if cls.MAIL_USERNAME or cls.MAIL_PASSWORD:
                auth = (cls.MAIL_USERNAME, cls.MAIL_PASSWORD)
            secure = None
            if cls.MAIL_USE_TLS:
                secure = ()
            mail_handler = SMTPHandler(
                mailhost=(cls.MAIL_SERVER, cls.MAIL_PORT),
                fromaddr=cls.MAIL_SENDER,
                toaddrs=['admin@myapp.com'],
                subject='MyApp Failure',
                credentials=auth, secure=secure)
            mail_handler.setLevel(logging.ERROR)
            app.logger.addHandler(mail_handler)
        
        app.logger.setLevel(logging.INFO)
        app.logger.info('MyApp startup')

# é…ç½®å­—å…¸
config: dict[str, Type[Config]] = {
    'development': DevelopmentConfig,
    'testing': TestingConfig,
    'production': ProductionConfig,
    'default': DevelopmentConfig
}
```

### ç¯å¢ƒå˜é‡ç®¡ç†

```python
# .env æ–‡ä»¶ç¤ºä¾‹
FLASK_APP=run.py
FLASK_ENV=development
SECRET_KEY=your-secret-key-here
DATABASE_URL=postgresql://user:pass@localhost/myapp
REDIS_URL=redis://localhost:6379/0
MAIL_SERVER=smtp.gmail.com
MAIL_PORT=587
MAIL_USE_TLS=true
MAIL_USERNAME=your-email@gmail.com
MAIL_PASSWORD=your-app-password

# ç¯å¢ƒå˜é‡åŠ è½½
from dotenv import load_dotenv
import os

# åŠ è½½.envæ–‡ä»¶
load_dotenv()

# è·å–ç¯å¢ƒå˜é‡çš„è¾…åŠ©å‡½æ•°
def get_env_variable(var_name: str, default=None, var_type=str):
    """è·å–ç¯å¢ƒå˜é‡å¹¶è¿›è¡Œç±»å‹è½¬æ¢"""
    value = os.environ.get(var_name, default)
    if value is None:
        return None
    
    if var_type == bool:
        return value.lower() in ['true', '1', 'on', 'yes']
    elif var_type == int:
        return int(value)
    elif var_type == float:
        return float(value)
    else:
        return value

# ä½¿ç”¨ç¤ºä¾‹
class Config:
    SECRET_KEY = get_env_variable('SECRET_KEY', 'dev-secret-key')
    DEBUG = get_env_variable('DEBUG', False, bool)
    DATABASE_URL = get_env_variable('DATABASE_URL')
    REDIS_URL = get_env_variable('REDIS_URL', 'redis://localhost:6379/0')
    MAIL_PORT = get_env_variable('MAIL_PORT', 587, int)
```

é€šè¿‡ä»¥ä¸Šæ·±å…¥çš„ Flask æ ¸å¿ƒæ¦‚å¿µè®²è§£ï¼Œæ‚¨å°†å…¨é¢ç†è§£ Flask çš„å·¥ä½œåŸç†å’Œæ ¸å¿ƒæœºåˆ¶ï¼Œä¸ºæ„å»ºå¤æ‚çš„ Web åº”ç”¨å¥ å®šåšå®çš„ç†è®ºåŸºç¡€ã€‚