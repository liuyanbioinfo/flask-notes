# ğŸš€ 13. éƒ¨ç½²ç­–ç•¥ä¸ç¯å¢ƒç®¡ç†

åœ¨å®ŒæˆFlaskåº”ç”¨å¼€å‘åï¼Œå¦‚ä½•å°†åº”ç”¨ç¨³å®šã€é«˜æ•ˆåœ°éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒæ˜¯æ¯ä¸ªå¼€å‘è€…å¿…é¡»æŒæ¡çš„å…³é”®æŠ€èƒ½ã€‚æœ¬ç« å°†æ·±å…¥æ¢è®¨Flaskåº”ç”¨çš„éƒ¨ç½²ç­–ç•¥ï¼Œä»ç¯å¢ƒè§„åˆ’åˆ°å®¹å™¨åŒ–éƒ¨ç½²ï¼Œä»æœåŠ¡å™¨é…ç½®åˆ°é«˜å¯ç”¨æ¶æ„è®¾è®¡ã€‚

## ğŸ“‹ 13.1 éƒ¨ç½²ç¯å¢ƒè§„åˆ’

### ç¯å¢ƒåˆ†å±‚ç­–ç•¥

ç°ä»£Webåº”ç”¨é€šå¸¸é‡‡ç”¨å¤šç¯å¢ƒåˆ†å±‚çš„éƒ¨ç½²ç­–ç•¥ï¼Œç¡®ä¿ä»£ç è´¨é‡å’Œç³»ç»Ÿç¨³å®šæ€§ï¼š

```mermaid
graph TD
    A[å¼€å‘ç¯å¢ƒ Development] --> B[æµ‹è¯•ç¯å¢ƒ Testing]
    B --> C[é¢„å‘å¸ƒç¯å¢ƒ Staging]
    C --> D[ç”Ÿäº§ç¯å¢ƒ Production]
    
    A1[æœ¬åœ°å¼€å‘<br/>å¿«é€Ÿè¿­ä»£] --> A
    B1[è‡ªåŠ¨åŒ–æµ‹è¯•<br/>åŠŸèƒ½éªŒè¯] --> B
    C1[ç”Ÿäº§æ¨¡æ‹Ÿ<br/>æœ€ç»ˆéªŒè¯] --> C
    D1[ç”¨æˆ·è®¿é—®<br/>ç¨³å®šè¿è¡Œ] --> D
```

### ç¯å¢ƒé…ç½®ç®¡ç†

ä½¿ç”¨é…ç½®ç±»æ¥ç®¡ç†ä¸åŒç¯å¢ƒçš„é…ç½®ï¼š

config.py
```python
import os
from datetime import timedelta

class Config:
    """åŸºç¡€é…ç½®ç±»"""
    SECRET_KEY = os.environ.get('SECRET_KEY') or 'dev-secret-key'
    SQLALCHEMY_TRACK_MODIFICATIONS = False
    PERMANENT_SESSION_LIFETIME = timedelta(hours=1)

class DevelopmentConfig(Config):
    """å¼€å‘ç¯å¢ƒé…ç½®"""
    DEBUG = True
    SQLALCHEMY_DATABASE_URI = os.environ.get('DEV_DATABASE_URL') or \
        'sqlite:///app_dev.db'
    
class ProductionConfig(Config):
    """ç”Ÿäº§ç¯å¢ƒé…ç½®"""
    DEBUG = False
    SQLALCHEMY_DATABASE_URI = os.environ.get('DATABASE_URL') or \
        'postgresql://user:pass@localhost/proddb'
    
    # ç”Ÿäº§ç¯å¢ƒå®‰å…¨é…ç½®
    SESSION_COOKIE_SECURE = True
    SESSION_COOKIE_HTTPONLY = True
    SESSION_COOKIE_SAMESITE = 'Lax'

config = {
    'development': DevelopmentConfig,
    'production': ProductionConfig,
    'default': DevelopmentConfig
}
```

### ç¯å¢ƒå˜é‡ç®¡ç†

åˆ›å»º `.env` æ–‡ä»¶ç®¡ç†æ•æ„Ÿé…ç½®ï¼š

```bash
# æ•°æ®åº“é…ç½®
DATABASE_URL=postgresql://username:password@localhost:5432/myapp

# å®‰å…¨é…ç½®
SECRET_KEY=your-super-secret-key-here
JWT_SECRET_KEY=jwt-secret-key

# ç¬¬ä¸‰æ–¹æœåŠ¡
REDIS_URL=redis://localhost:6379/0
MAIL_SERVER=smtp.gmail.com
MAIL_USERNAME=your-email@gmail.com
```

## ğŸ³ 13.2 å®¹å™¨åŒ–éƒ¨ç½²ï¼ˆDockerï¼‰

### DockeråŒ–çš„ä¼˜åŠ¿

Dockerå®¹å™¨åŒ–éƒ¨ç½²è§£å†³äº†"åœ¨æˆ‘æœºå™¨ä¸Šèƒ½è¿è¡Œ"çš„ç»å…¸é—®é¢˜ï¼š

```mermaid
graph LR
    A[å¼€å‘ç¯å¢ƒ] --> B[Dockeré•œåƒ]
    C[æµ‹è¯•ç¯å¢ƒ] --> B
    D[ç”Ÿäº§ç¯å¢ƒ] --> B
    
    B --> E[ä¸€è‡´çš„è¿è¡Œç¯å¢ƒ]
    E --> F[å¯é¢„æµ‹çš„è¡Œä¸º]
    E --> G[ç®€åŒ–éƒ¨ç½²æµç¨‹]
    E --> H[æ˜“äºæ‰©å±•]
```

### Dockerfileæœ€ä½³å®è·µ
Dockerfile
```dockerfile
# ä½¿ç”¨å®˜æ–¹Pythonè¿è¡Œæ—¶ä½œä¸ºåŸºç¡€é•œåƒ
FROM python:3.11-slim

# è®¾ç½®å·¥ä½œç›®å½•
WORKDIR /app

# è®¾ç½®ç¯å¢ƒå˜é‡
ENV PYTHONDONTWRITEBYTECODE=1 \
    PYTHONUNBUFFERED=1 \
    FLASK_APP=app.py

# å®‰è£…ç³»ç»Ÿä¾èµ–
RUN apt-get update && apt-get install -y \
    gcc \
    && rm -rf /var/lib/apt/lists/*

# å¤åˆ¶ä¾èµ–æ–‡ä»¶å¹¶å®‰è£…PythonåŒ…
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# å¤åˆ¶åº”ç”¨ä»£ç 
COPY . .

# åˆ›å»ºérootç”¨æˆ·
RUN useradd --create-home --shell /bin/bash app \
    && chown -R app:app /app
USER app

# æš´éœ²ç«¯å£
EXPOSE 5000

# å¥åº·æ£€æŸ¥
HEALTHCHECK --interval=30s --timeout=30s --start-period=5s --retries=3 \
    CMD curl -f http://localhost:5000/health || exit 1

# å¯åŠ¨å‘½ä»¤
CMD ["gunicorn", "--bind", "0.0.0.0:5000", "app:app"]
```

### Docker Composeç¼–æ’
docker-compose.yml
```yaml
version: '3.8'

services:
  web:
    build: .
    ports:
      - "5000:5000"
    environment:
      - FLASK_ENV=production
      - DATABASE_URL=postgresql://postgres:password@db:5432/myapp
      - REDIS_URL=redis://redis:6379/0
    depends_on:
      - db
      - redis
    volumes:
      - ./logs:/app/logs
    restart: unless-stopped

  db:
    image: postgres:15
    environment:
      - POSTGRES_DB=myapp
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=password
    volumes:
      - postgres_data:/var/lib/postgresql/data
    restart: unless-stopped

  redis:
    image: redis:7-alpine
    restart: unless-stopped

  nginx:
    image: nginx:alpine
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf
      - ./ssl:/etc/nginx/ssl
    depends_on:
      - web
    restart: unless-stopped

volumes:
  postgres_data:
```

## âš™ï¸ 13.3 WSGIæœåŠ¡å™¨é€‰æ‹©ä¸é…ç½®

### WSGIæœåŠ¡å™¨å¯¹æ¯”

```mermaid
graph TD
    A[WSGIæœåŠ¡å™¨é€‰æ‹©] --> B[Gunicorn]
    A --> C[uWSGI]
    A --> D[Waitress]
    
    B --> B1[âœ… ç®€å•æ˜“ç”¨<br/>âœ… æ€§èƒ½ä¼˜ç§€<br/>âœ… ç¤¾åŒºæ´»è·ƒ]
    C --> C1[âœ… åŠŸèƒ½ä¸°å¯Œ<br/>âœ… é«˜åº¦å¯é…ç½®<br/>âŒ é…ç½®å¤æ‚]
    D --> D1[âœ… çº¯Python<br/>âœ… Windowså‹å¥½<br/>âŒ æ€§èƒ½ä¸€èˆ¬]
```

### Gunicorné…ç½®ç¤ºä¾‹
gunicorn.conf.py
```python
# Gunicorné…ç½®æ–‡ä»¶
import multiprocessing

# æœåŠ¡å™¨å¥—æ¥å­—
bind = "0.0.0.0:5000"
backlog = 2048

# å·¥ä½œè¿›ç¨‹
workers = multiprocessing.cpu_count() * 2 + 1
worker_class = "sync"
worker_connections = 1000
timeout = 30
keepalive = 2

# é‡å¯
max_requests = 1000
max_requests_jitter = 50
preload_app = True

# æ—¥å¿—
accesslog = "/var/log/gunicorn/access.log"
errorlog = "/var/log/gunicorn/error.log"
loglevel = "info"
access_log_format = '%(h)s %(l)s %(u)s %(t)s "%(r)s" %(s)s %(b)s "%(f)s" "%(a)s"'

# è¿›ç¨‹å‘½å
proc_name = 'flask_app'

# ç”¨æˆ·æƒé™
user = 'www-data'
group = 'www-data'
```

### å¯åŠ¨è„šæœ¬

start.sh
```bash
#!/bin/bash

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
source venv/bin/activate

# æ•°æ®åº“è¿ç§»
flask db upgrade

# å¯åŠ¨Gunicorn
exec gunicorn --config gunicorn.conf.py app:app
```

## ğŸ”„ 13.4 åå‘ä»£ç†é…ç½®ï¼ˆNginxã€Apacheï¼‰

### Nginxé…ç½®æœ€ä½³å®è·µ
nginx.conf
```nginx
upstream flask_app {
    server 127.0.0.1:5000;
    # å¤šå®ä¾‹è´Ÿè½½å‡è¡¡
    # server 127.0.0.1:5001;
    # server 127.0.0.1:5002;
}

server {
    listen 80;
    server_name yourdomain.com www.yourdomain.com;
    
    # HTTPé‡å®šå‘åˆ°HTTPS
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    server_name yourdomain.com www.yourdomain.com;
    
    # SSLé…ç½®
    ssl_certificate /etc/nginx/ssl/cert.pem;
    ssl_certificate_key /etc/nginx/ssl/key.pem;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-RSA-AES256-GCM-SHA512:DHE-RSA-AES256-GCM-SHA512;
    
    # å®‰å…¨å¤´
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header Strict-Transport-Security "max-age=63072000" always;
    
    # é™æ€æ–‡ä»¶å¤„ç†
    location /static {
        alias /app/static;
        expires 1y;
        add_header Cache-Control "public, immutable";
    }
    
    # åº”ç”¨ä»£ç†
    location / {
        proxy_pass http://flask_app;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # è¶…æ—¶è®¾ç½®
        proxy_connect_timeout 30s;
        proxy_send_timeout 30s;
        proxy_read_timeout 30s;
    }
    
    # å¥åº·æ£€æŸ¥
    location /health {
        access_log off;
        proxy_pass http://flask_app;
    }
}
```

### è¯·æ±‚æµç¨‹å›¾

```mermaid
sequenceDiagram
    participant Client
    participant Nginx
    participant Gunicorn
    participant Flask
    
    Client->>Nginx: HTTPSè¯·æ±‚
    Nginx->>Nginx: SSLç»ˆæ­¢
    Nginx->>Nginx: é™æ€æ–‡ä»¶æ£€æŸ¥
    alt é™æ€æ–‡ä»¶
        Nginx->>Client: ç›´æ¥è¿”å›é™æ€æ–‡ä»¶
    else åŠ¨æ€è¯·æ±‚
        Nginx->>Gunicorn: ä»£ç†è¯·æ±‚
        Gunicorn->>Flask: å¤„ç†è¯·æ±‚
        Flask->>Gunicorn: è¿”å›å“åº”
        Gunicorn->>Nginx: è¿”å›å“åº”
        Nginx->>Client: è¿”å›å“åº”
    end
```

## âš–ï¸ 13.5 è´Ÿè½½å‡è¡¡ä¸é«˜å¯ç”¨

### è´Ÿè½½å‡è¡¡ç­–ç•¥

```mermaid
graph TD
    A[è´Ÿè½½å‡è¡¡å™¨] --> B[åº”ç”¨æœåŠ¡å™¨1]
    A --> C[åº”ç”¨æœåŠ¡å™¨2]
    A --> D[åº”ç”¨æœåŠ¡å™¨3]
    
    B --> E[æ•°æ®åº“ä¸»èŠ‚ç‚¹]
    C --> E
    D --> E
    
    E --> F[æ•°æ®åº“ä»èŠ‚ç‚¹1]
    E --> G[æ•°æ®åº“ä»èŠ‚ç‚¹2]
    
    H[Redisé›†ç¾¤] --> B
    H --> C
    H --> D
```

### Nginxè´Ÿè½½å‡è¡¡é…ç½®
load_balance.conf
```nginx
upstream flask_cluster {
    # è´Ÿè½½å‡è¡¡ç­–ç•¥
    least_conn;  # æœ€å°‘è¿æ¥æ•°
    
    server 10.0.1.10:5000 weight=3 max_fails=3 fail_timeout=30s;
    server 10.0.1.11:5000 weight=2 max_fails=3 fail_timeout=30s;
    server 10.0.1.12:5000 weight=1 max_fails=3 fail_timeout=30s backup;
}

server {
    listen 80;
    
    location / {
        proxy_pass http://flask_cluster;
        
        # ä¼šè¯ä¿æŒï¼ˆå¦‚æœéœ€è¦ï¼‰
        # ip_hash;
        
        # å¥åº·æ£€æŸ¥
        proxy_next_upstream error timeout invalid_header http_500 http_502 http_503;
    }
}
```

### é«˜å¯ç”¨æ¶æ„è®¾è®¡
health_check.py
```python
from flask import Flask, jsonify
import psutil
import redis
from sqlalchemy import text
from app import db

def create_health_check_blueprint():
    health_bp = Blueprint('health', __name__)
    
    @health_bp.route('/health')
    def health_check():
        """åŸºç¡€å¥åº·æ£€æŸ¥"""
        return jsonify({
            'status': 'healthy',
            'timestamp': datetime.utcnow().isoformat()
        })
    
    @health_bp.route('/health/detailed')
    def detailed_health_check():
        """è¯¦ç»†å¥åº·æ£€æŸ¥"""
        checks = {
            'database': check_database(),
            'redis': check_redis(),
            'disk_space': check_disk_space(),
            'memory': check_memory()
        }
        
        overall_status = 'healthy' if all(checks.values()) else 'unhealthy'
        
        return jsonify({
            'status': overall_status,
            'checks': checks,
            'timestamp': datetime.utcnow().isoformat()
        })
    
    def check_database():
        try:
            db.session.execute(text('SELECT 1'))
            return True
        except Exception:
            return False
    
    def check_redis():
        try:
            r = redis.Redis.from_url(current_app.config['REDIS_URL'])
            r.ping()
            return True
        except Exception:
            return False
    
    def check_disk_space():
        disk_usage = psutil.disk_usage('/')
        return disk_usage.percent < 90  # ç£ç›˜ä½¿ç”¨ç‡å°äº90%
    
    def check_memory():
        memory = psutil.virtual_memory()
        return memory.percent < 85  # å†…å­˜ä½¿ç”¨ç‡å°äº85%
    
    return health_bp
```

## ğŸ’¾ 13.6 æ•°æ®åº“éƒ¨ç½²ä¸å¤‡ä»½ç­–ç•¥

### æ•°æ®åº“éƒ¨ç½²æ¶æ„

```mermaid
graph TD
    A[åº”ç”¨å±‚] --> B[æ•°æ®åº“ä»£ç†]
    B --> C[ä¸»æ•°æ®åº“]
    B --> D[ä»æ•°æ®åº“1]
    B --> E[ä»æ•°æ®åº“2]
    
    C --> F[å®šæ—¶å¤‡ä»½]
    F --> G[æœ¬åœ°å¤‡ä»½]
    F --> H[äº‘ç«¯å¤‡ä»½]
    
    I[ç›‘æ§ç³»ç»Ÿ] --> C
    I --> D
    I --> E
```

### æ•°æ®åº“è¿æ¥æ± é…ç½®
database.py
```python
from sqlalchemy import create_engine
from sqlalchemy.pool import QueuePool

def create_database_engine(database_url):
    """åˆ›å»ºæ•°æ®åº“å¼•æ“"""
    return create_engine(
        database_url,
        poolclass=QueuePool,
        pool_size=20,          # è¿æ¥æ± å¤§å°
        max_overflow=30,       # æœ€å¤§æº¢å‡ºè¿æ¥æ•°
        pool_pre_ping=True,    # è¿æ¥å‰æ£€æŸ¥
        pool_recycle=3600,     # è¿æ¥å›æ”¶æ—¶é—´ï¼ˆç§’ï¼‰
        echo=False             # ç”Ÿäº§ç¯å¢ƒå…³é—­SQLæ—¥å¿—
    )

# è¯»å†™åˆ†ç¦»é…ç½®
class DatabaseConfig:
    SQLALCHEMY_DATABASE_URI = 'postgresql://user:pass@master:5432/db'
    SQLALCHEMY_BINDS = {
        'slave': 'postgresql://user:pass@slave:5432/db'
    }
```

### å¤‡ä»½è„šæœ¬
backup.sh
```bash
#!/bin/bash

# æ•°æ®åº“å¤‡ä»½è„šæœ¬
DATE=$(date +"%Y%m%d_%H%M%S")
BACKUP_DIR="/backups"
DB_NAME="myapp"
DB_USER="postgres"

# åˆ›å»ºå¤‡ä»½ç›®å½•
mkdir -p $BACKUP_DIR

# æ‰§è¡Œå¤‡ä»½
pg_dump -U $DB_USER -h localhost $DB_NAME | gzip > $BACKUP_DIR/backup_$DATE.sql.gz

# ä¸Šä¼ åˆ°äº‘å­˜å‚¨ï¼ˆç¤ºä¾‹ï¼šAWS S3ï¼‰
aws s3 cp $BACKUP_DIR/backup_$DATE.sql.gz s3://my-backups/database/

# æ¸…ç†æœ¬åœ°æ—§å¤‡ä»½ï¼ˆä¿ç•™7å¤©ï¼‰
find $BACKUP_DIR -name "backup_*.sql.gz" -mtime +7 -delete

echo "Backup completed: backup_$DATE.sql.gz"
```

### éƒ¨ç½²æ£€æŸ¥æ¸…å• âœ…

åœ¨éƒ¨ç½²Flaskåº”ç”¨åˆ°ç”Ÿäº§ç¯å¢ƒå‰ï¼Œè¯·ç¡®ä¿å®Œæˆä»¥ä¸‹æ£€æŸ¥é¡¹ï¼š

**å®‰å…¨æ£€æŸ¥**
- [ ] ç§»é™¤è°ƒè¯•æ¨¡å¼ (`DEBUG = False`)
- [ ] è®¾ç½®å¼ºå¯†é’¥ (`SECRET_KEY`)
- [ ] é…ç½®HTTPSå’ŒSSLè¯ä¹¦
- [ ] è®¾ç½®å®‰å…¨HTTPå¤´
- [ ] å¯ç”¨CSRFä¿æŠ¤

**æ€§èƒ½æ£€æŸ¥**
- [ ] é…ç½®é€‚å½“çš„WSGIæœåŠ¡å™¨
- [ ] è®¾ç½®åå‘ä»£ç†
- [ ] å¯ç”¨é™æ€æ–‡ä»¶ç¼“å­˜
- [ ] é…ç½®æ•°æ®åº“è¿æ¥æ± 
- [ ] å®æ–½ç¼“å­˜ç­–ç•¥

**ç›‘æ§æ£€æŸ¥**
- [ ] é…ç½®æ—¥å¿—è®°å½•
- [ ] è®¾ç½®å¥åº·æ£€æŸ¥ç«¯ç‚¹
- [ ] é…ç½®ç›‘æ§å‘Šè­¦
- [ ] å®æ–½é”™è¯¯è¿½è¸ª

**å¤‡ä»½æ£€æŸ¥**
- [ ] é…ç½®æ•°æ®åº“å¤‡ä»½
- [ ] æµ‹è¯•æ¢å¤æµç¨‹
- [ ] è®¾ç½®å¤‡ä»½ç›‘æ§

é€šè¿‡ç³»ç»Ÿæ€§çš„éƒ¨ç½²ç­–ç•¥å’Œç¯å¢ƒç®¡ç†ï¼Œæˆ‘ä»¬å¯ä»¥ç¡®ä¿Flaskåº”ç”¨åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ç¨³å®šã€å®‰å…¨ã€é«˜æ•ˆåœ°è¿è¡Œã€‚ä¸‹ä¸€ç« æˆ‘ä»¬å°†æ·±å…¥æ¢è®¨äº‘å¹³å°éƒ¨ç½²çš„å…·ä½“å®è·µã€‚
        